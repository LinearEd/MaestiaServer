PROGRAM  : Maestia.exe
FUNCTION : FUN_008e51c0
ENTRY    : 008e51c0
BODY     : [[008e51c0, 008e564d]]

============================================================
DECOMPILED C CODE
============================================================

void FUN_008e51c0(int param_1)

{
  char cVar1;
  uint uVar2;
  int iVar3;
  undefined4 uVar4;
  int iVar5;
  DWORD DVar6;
  int iVar7;
  wchar_t ****_Source;
  int in_ECX;
  wchar_t *_Src;
  undefined1 local_374 [28];
  int local_358;
  undefined1 local_354 [4];
  wchar_t ***local_350 [4];
  size_t local_340;
  uint local_33c;
  undefined2 local_338;
  undefined1 local_336 [398];
  wchar_t local_1a8;
  undefined1 local_1a6 [398];
  uint local_18;
  void *local_10;
  undefined1 *puStack_c;
  int local_8;
  
  local_8 = 0xffffffff;
  puStack_c = &LAB_00b3f038;
  local_10 = ExceptionList;
  uVar2 = DAT_00d66fa0 ^ (uint)&stack0xfffffffc;
  ExceptionList = &local_10;
  local_18 = uVar2;
  if ((param_1 == 0) || ((uint)((*(int *)(param_1 + 8) - *(int *)(param_1 + 4)) / 0x1c) < 4))
  goto LAB_008e5630;
  local_358 = in_ECX;
  iVar3 = FUN_00405bb0(&DAT_00c59eb8);
  if (iVar3 == 0) {
    FUN_00405c00(in_ECX + 0x78);
    goto LAB_008e5630;
  }
  cVar1 = FUN_00403810(uVar2);
  if (cVar1 == '\0') {
    cVar1 = FUN_00403810(uVar2);
    if (cVar1 != '\0') {
      FUN_00405c00(local_358 + 0x5c);
      goto LAB_008e5630;
    }
    cVar1 = FUN_00403810(uVar2);
    if (cVar1 != '\0') goto LAB_008e5630;
    uVar2 = 0;
    iVar5 = FUN_00703c00(0x8800);
    iVar3 = local_358;
    if (iVar5 != 0) {
      uVar2 = *(uint *)(iVar5 + 0x40);
    }
    if (*(uint *)(*(int *)(DAT_0172491c + 0x17c) + 0x1ed0) < uVar2) {
      FUN_00406460(L"IDS_GUI_NEED_GOLD");
      local_8 = 2;
      uVar4 = FUN_0081d120(local_374);
      local_8._0_1_ = 3;
      FUN_008ede80(uVar4,2);
      local_8 = CONCAT31(local_8._1_3_,2);
      goto LAB_008e52d2;
    }
    if (*(int *)(local_358 + 0x98) == 2) goto LAB_008e5630;
    if (*(int *)(local_358 + 0x98) == 3) {
      *(undefined4 *)(local_358 + 0x98) = 0;
      goto LAB_008e5630;
    }
    local_33c = 7;
    local_340 = 0;
    local_350[0] = (wchar_t ***)((uint)local_350[0] & 0xffff0000);
    local_8 = 4;
    FUN_00405d70(*(int *)(param_1 + 4) + 0x1c);
    FUN_00405d70(*(int *)(param_1 + 4) + 0x38);
    cVar1 = FUN_00403810();
    if ((cVar1 == '\0') && (cVar1 = FUN_00403810(), iVar5 = local_358, cVar1 == '\0')) {
      if (*(uint *)(local_358 + 0x70) < 0x191) {
        DVar6 = timeGetTime();
        if (999 < DVar6 - *(int *)(iVar5 + 0x9c)) {
          iVar7 = FUN_006f4590();
          local_8._0_1_ = 7;
          if (iVar7 == 0) {
            iVar3 = 0;
          }
          else {
            if (*(uint *)(iVar5 + 0x74) < 8) {
              iVar5 = iVar5 + 0x60;
            }
            else {
              iVar5 = *(int *)(iVar5 + 0x60);
            }
            if (*(uint *)(iVar3 + 0x90) < 8) {
              iVar3 = FUN_0042cd40(iVar5);
              iVar5 = local_358;
            }
            else {
              iVar3 = FUN_0042cd40(iVar5);
              iVar5 = local_358;
            }
          }
          local_8 = CONCAT31(local_8._1_3_,4);
          local_1a8 = L'\0';
          _memset(local_1a6,0,0x18e);
          local_338 = 0;
          _memset(local_336,0,0x18e);
          iVar7 = *(int *)(param_1 + 4);
          if (*(uint *)(iVar7 + 0x88) < 8) {
            _Src = (wchar_t *)(iVar7 + 0x74);
          }
          else {
            _Src = *(wchar_t **)(iVar7 + 0x74);
          }
          _wcscpy_s(&local_1a8,200,_Src);
          FUN_006efb90(200);
          FUN_00405c00(local_354);
          _Source = (wchar_t ****)local_350[0];
          if (local_33c < 8) {
            _Source = local_350;
          }
          _wcsncpy((wchar_t *)(iVar3 + 0xd6),(wchar_t *)_Source,local_340);
          *(undefined2 *)(iVar3 + 0xd4) = (undefined2)local_340;
          FUN_00a0d580(iVar3);
          DVar6 = timeGetTime();
          *(DWORD *)(iVar5 + 0x9c) = DVar6;
        }
      }
      else {
        FUN_00406460(L"IDS_GUI_MAX_STRING_OVER");
        local_8._0_1_ = 5;
        uVar4 = FUN_0081d120(local_374);
        local_8._0_1_ = 6;
        FUN_008ede80(uVar4,2);
        local_8._0_1_ = 5;
        FUN_00406560();
        local_8 = CONCAT31(local_8._1_3_,4);
        FUN_00406560();
      }
    }
  }
  else {
    FUN_00405c00(local_358 + 0x78);
    FUN_00406460(L"IDS_GUI_CANT_SEND_SELF");
    local_8 = 0;
    uVar4 = FUN_0081d120(local_374);
    local_8._0_1_ = 1;
    FUN_008ede80(uVar4,2);
    local_8 = (uint)local_8._1_3_ << 8;
LAB_008e52d2:
    FUN_00406560();
  }
  local_8 = 0xffffffff;
  FUN_00406560();
LAB_008e5630:
  ExceptionList = local_10;
  __security_check_cookie(local_18 ^ (uint)&stack0xfffffffc);
  return;
}



============================================================
DISASSEMBLY
============================================================
008e51c0 : PUSH EBP
008e51c1 : MOV EBP,ESP
008e51c3 : PUSH -0x1
008e51c5 : PUSH 0xb3f038
008e51ca : MOV EAX,FS:[0x0]
008e51d0 : PUSH EAX
008e51d1 : SUB ESP,0x388
008e51d7 : MOV EAX,[0x00d66fa0]
008e51dc : XOR EAX,EBP
008e51de : MOV dword ptr [EBP + -0x14],EAX
008e51e1 : PUSH EBX
008e51e2 : PUSH ESI
008e51e3 : PUSH EDI
008e51e4 : PUSH EAX
008e51e5 : LEA EAX,[EBP + -0xc]
008e51e8 : MOV FS:[0x0],EAX
008e51ee : MOV EBX,dword ptr [EBP + 0x8]
008e51f1 : MOV ESI,ECX
008e51f3 : MOV dword ptr [EBP + 0xfffffcac],ESI
008e51f9 : TEST EBX,EBX
008e51fb : JZ 0x008e5630
008e5201 : MOV EDI,dword ptr [EBX + 0x4]
008e5204 : MOV ECX,dword ptr [EBX + 0x8]
008e5207 : SUB ECX,EDI
008e5209 : MOV EAX,0x92492493
008e520e : IMUL ECX
008e5210 : ADD EDX,ECX
008e5212 : SAR EDX,0x4
008e5215 : MOV EAX,EDX
008e5217 : SHR EAX,0x1f
008e521a : ADD EAX,EDX
008e521c : CMP EAX,0x4
008e521f : JC 0x008e5630
008e5225 : MOV EAX,dword ptr [EDI + 0x30]
008e5228 : LEA ECX,[EDI + 0x1c]
008e522b : PUSH 0xc59eb8
008e5230 : XOR EDI,EDI
008e5232 : CALL 0x00405bb0
008e5237 : TEST EAX,EAX
008e5239 : JNZ 0x008e524e
008e523b : ADD ESI,0x78
008e523e : PUSH ESI
008e523f : MOV EDX,0xc59ebc
008e5244 : CALL 0x00405c00
008e5249 : JMP 0x008e5630
008e524e : MOV ECX,dword ptr [0x0172491c]
008e5254 : MOV EAX,dword ptr [ECX + 0x17c]
008e525a : CMP dword ptr [EAX + 0x24],0x8
008e525e : JC 0x008e5265
008e5260 : MOV ESI,dword ptr [EAX + 0x10]
008e5263 : JMP 0x008e5268
008e5265 : LEA ESI,[EAX + 0x10]
008e5268 : MOV ECX,dword ptr [EBX + 0x4]
008e526b : ADD ECX,0x1c
008e526e : CALL 0x00403810
008e5273 : TEST AL,AL
008e5275 : JZ 0x008e52ef
008e5277 : MOV EDX,dword ptr [EBP + 0xfffffcac]
008e527d : ADD EDX,0x78
008e5280 : PUSH EDX
008e5281 : MOV EDX,0xc59ec0
008e5286 : CALL 0x00405c00
008e528b : PUSH 0xc59ec4
008e5290 : LEA ECX,[EBP + 0xfffffc90]
008e5296 : CALL 0x00406460
008e529b : MOV dword ptr [EBP + -0x4],0x0
008e52a2 : MOV ECX,dword ptr [0x0172491c]
008e52a8 : LEA EAX,[EBP + 0xfffffc90]
008e52ae : PUSH EAX
008e52af : LEA EDI,[EBP + 0xfffffc70]
008e52b5 : CALL 0x0081d120
008e52ba : MOV byte ptr [EBP + -0x4],0x1
008e52be : MOV ECX,dword ptr [0x00da9894]
008e52c4 : MOV ECX,dword ptr [ECX]
008e52c6 : PUSH 0x2
008e52c8 : PUSH EAX
008e52c9 : CALL 0x008ede80
008e52ce : MOV byte ptr [EBP + -0x4],0x0
008e52d2 : LEA ECX,[EBP + 0xfffffc70]
008e52d8 : CALL 0x00406560
008e52dd : MOV dword ptr [EBP + -0x4],0xffffffff
008e52e4 : LEA ECX,[EBP + 0xfffffc90]
008e52ea : JMP 0x008e562b
008e52ef : MOV ECX,dword ptr [EBX + 0x4]
008e52f2 : ADD ECX,0x38
008e52f5 : MOV ESI,0xc59ef4
008e52fa : CALL 0x00403810
008e52ff : TEST AL,AL
008e5301 : JZ 0x008e531c
008e5303 : MOV EDX,dword ptr [EBP + 0xfffffcac]
008e5309 : ADD EDX,0x5c
008e530c : PUSH EDX
008e530d : MOV EDX,0xc59ef8
008e5312 : CALL 0x00405c00
008e5317 : JMP 0x008e5630
008e531c : MOV ECX,dword ptr [EBX + 0x4]
008e531f : ADD ECX,0x54
008e5322 : MOV ESI,0xc59efc
008e5327 : CALL 0x00403810
008e532c : TEST AL,AL
008e532e : JNZ 0x008e5630
008e5334 : XOR ESI,ESI
008e5336 : PUSH 0x8800
008e533b : LEA EDI,[ESI + 0x1]
008e533e : CALL 0x00703c00
008e5343 : ADD ESP,0x4
008e5346 : TEST EAX,EAX
008e5348 : JZ 0x008e534d
008e534a : MOV ESI,dword ptr [EAX + 0x40]
008e534d : MOV EAX,[0x0172491c]
008e5352 : MOV EAX,dword ptr [EAX + 0x17c]
008e5358 : CMP dword ptr [EAX + 0x1ed0],ESI
008e535e : JNC 0x008e53ac
008e5360 : PUSH 0xc59f00
008e5365 : LEA ECX,[EBP + 0xfffffc90]
008e536b : CALL 0x00406460
008e5370 : MOV dword ptr [EBP + -0x4],0x2
008e5377 : LEA ECX,[EBP + 0xfffffc90]
008e537d : PUSH ECX
008e537e : MOV ECX,dword ptr [0x0172491c]
008e5384 : LEA EDI,[EBP + 0xfffffc70]
008e538a : CALL 0x0081d120
008e538f : MOV byte ptr [EBP + -0x4],0x3
008e5393 : MOV EDX,dword ptr [0x00da9894]
008e5399 : MOV ECX,dword ptr [EDX]
008e539b : PUSH 0x2
008e539d : PUSH EAX
008e539e : CALL 0x008ede80
008e53a3 : MOV byte ptr [EBP + -0x4],0x2
008e53a7 : JMP 0x008e52d2
008e53ac : MOV ESI,dword ptr [EBP + 0xfffffcac]
008e53b2 : MOV EAX,dword ptr [ESI + 0x98]
008e53b8 : CMP EAX,0x2
008e53bb : JZ 0x008e5630
008e53c1 : CMP EAX,0x3
008e53c4 : JNZ 0x008e53d5
008e53c6 : MOV dword ptr [ESI + 0x98],0x0
008e53d0 : JMP 0x008e5630
008e53d5 : XOR EAX,EAX
008e53d7 : MOV dword ptr [EBP + 0xfffffcc8],0x7
008e53e1 : MOV dword ptr [EBP + 0xfffffcc4],0x0
008e53eb : MOV word ptr [EBP + 0xfffffcb4],AX
008e53f2 : MOV dword ptr [EBP + -0x4],0x4
008e53f9 : MOV ECX,dword ptr [EBX + 0x4]
008e53fc : ADD ECX,0x1c
008e53ff : LEA EDI,[ESI + 0x78]
008e5402 : PUSH ECX
008e5403 : MOV ECX,EDI
008e5405 : CALL 0x00405d70
008e540a : MOV EDX,dword ptr [EBX + 0x4]
008e540d : ADD EDX,0x38
008e5410 : LEA ECX,[ESI + 0x5c]
008e5413 : PUSH EDX
008e5414 : CALL 0x00405d70
008e5419 : MOV ESI,0xc59f24
008e541e : MOV ECX,EDI
008e5420 : CALL 0x00403810
008e5425 : TEST AL,AL
008e5427 : JNZ 0x008e561e
008e542d : MOV ECX,dword ptr [EBP + 0xfffffcac]
008e5433 : MOV ESI,0xc59f28
008e5438 : ADD ECX,0x5c
008e543b : CALL 0x00403810
008e5440 : TEST AL,AL
008e5442 : JNZ 0x008e561e
008e5448 : MOV ESI,dword ptr [EBP + 0xfffffcac]
008e544e : CMP dword ptr [ESI + 0x70],0x190
008e5455 : JBE 0x008e54b6
008e5457 : PUSH 0xc59f2c
008e545c : LEA ECX,[EBP + 0xfffffc90]
008e5462 : CALL 0x00406460
008e5467 : MOV BL,0x5
008e5469 : MOV byte ptr [EBP + -0x4],BL
008e546c : MOV ECX,dword ptr [0x0172491c]
008e5472 : LEA EAX,[EBP + 0xfffffc90]
008e5478 : PUSH EAX
008e5479 : LEA EDI,[EBP + 0xfffffc70]
008e547f : CALL 0x0081d120
008e5484 : MOV byte ptr [EBP + -0x4],0x6
008e5488 : MOV ECX,dword ptr [0x00da9894]
008e548e : MOV ECX,dword ptr [ECX]
008e5490 : PUSH 0x2
008e5492 : PUSH EAX
008e5493 : CALL 0x008ede80
008e5498 : MOV byte ptr [EBP + -0x4],BL
008e549b : MOV ECX,EDI
008e549d : CALL 0x00406560
008e54a2 : MOV byte ptr [EBP + -0x4],0x4
008e54a6 : LEA ECX,[EBP + 0xfffffc90]
008e54ac : CALL 0x00406560
008e54b1 : JMP 0x008e561e
008e54b6 : CALL dword ptr [0x00b85598]
008e54bc : SUB EAX,dword ptr [ESI + 0x9c]
008e54c2 : CMP EAX,0x3e8
008e54c7 : JC 0x008e561e
008e54cd : CALL 0x006f4590
008e54d2 : MOV dword ptr [EBP + 0xfffffc8c],EAX
008e54d8 : MOV byte ptr [EBP + -0x4],0x7
008e54dc : TEST EAX,EAX
008e54de : JZ 0x008e5528
008e54e0 : LEA ECX,[ESI + 0x5c]
008e54e3 : MOV EDX,0x8
008e54e8 : CMP dword ptr [ECX + 0x18],EDX
008e54eb : JC 0x008e54f2
008e54ed : MOV ECX,dword ptr [ECX + 0x4]
008e54f0 : JMP 0x008e54f5
008e54f2 : ADD ECX,0x4
008e54f5 : CMP dword ptr [EDI + 0x18],EDX
008e54f8 : JC 0x008e5511
008e54fa : MOV EDI,dword ptr [EDI + 0x4]
008e54fd : PUSH ECX
008e54fe : MOV ECX,EDI
008e5500 : MOV ESI,EAX
008e5502 : CALL 0x0042cd40
008e5507 : MOV ESI,dword ptr [EBP + 0xfffffcac]
008e550d : MOV EDI,EAX
008e550f : JMP 0x008e552a
008e5511 : ADD EDI,0x4
008e5514 : PUSH ECX
008e5515 : MOV ECX,EDI
008e5517 : MOV ESI,EAX
008e5519 : CALL 0x0042cd40
008e551e : MOV ESI,dword ptr [EBP + 0xfffffcac]
008e5524 : MOV EDI,EAX
008e5526 : JMP 0x008e552a
008e5528 : XOR EDI,EDI
008e552a : MOV byte ptr [EBP + -0x4],0x4
008e552e : XOR EDX,EDX
008e5530 : PUSH 0x18e
008e5535 : PUSH EDX
008e5536 : LEA EAX,[EBP + 0xfffffe5e]
008e553c : PUSH EAX
008e553d : MOV word ptr [EBP + 0xfffffe5c],DX
008e5544 : CALL 0x0063b700
008e5549 : ADD ESP,0xc
008e554c : XOR ECX,ECX
008e554e : PUSH 0x18e
008e5553 : PUSH ECX
008e5554 : LEA EDX,[EBP + 0xfffffcce]
008e555a : PUSH EDX
008e555b : MOV word ptr [EBP + 0xfffffccc],CX
008e5562 : CALL 0x0063b700
008e5567 : MOV EBX,dword ptr [EBX + 0x4]
008e556a : ADD EBX,0x70
008e556d : ADD ESP,0xc
008e5570 : CMP dword ptr [EBX + 0x18],0x8
008e5574 : JC 0x008e557b
008e5576 : MOV EBX,dword ptr [EBX + 0x4]
008e5579 : JMP 0x008e557e
008e557b : ADD EBX,0x4
008e557e : PUSH EBX
008e557f : LEA EAX,[EBP + 0xfffffe5c]
008e5585 : PUSH 0xc8
008e558a : PUSH EAX
008e558b : CALL 0x0063481b
008e5590 : ADD ESP,0xc
008e5593 : PUSH 0xc8
008e5598 : LEA EDX,[EBP + 0xfffffccc]
008e559e : LEA ECX,[EBP + 0xfffffe5c]
008e55a4 : CALL 0x006efb90
008e55a9 : ADD ESP,0x4
008e55ac : LEA ECX,[EBP + 0xfffffcb0]
008e55b2 : PUSH ECX
008e55b3 : LEA EDX,[EBP + 0xfffffccc]
008e55b9 : CALL 0x00405c00
008e55be : CMP dword ptr [EBP + 0xfffffcc8],0x8
008e55c5 : MOV EAX,dword ptr [EBP + 0xfffffcb4]
008e55cb : JNC 0x008e55d3
008e55cd : LEA EAX,[EBP + 0xfffffcb4]
008e55d3 : MOV EDX,dword ptr [EBP + 0xfffffcc4]
008e55d9 : PUSH EDX
008e55da : PUSH EAX
008e55db : LEA EAX,[EDI + 0xd6]
008e55e1 : PUSH EAX
008e55e2 : CALL 0x00634e39
008e55e7 : MOV CX,word ptr [EBP + 0xfffffcc4]
008e55ee : MOV EDX,dword ptr [0x017247d4]
008e55f4 : MOV word ptr [EDI + 0xd4],CX
008e55fb : MOVZX EAX,word ptr [EBP + 0xfffffcc4]
008e5602 : ADD ESP,0xc
008e5605 : LEA EAX,[EAX + EAX*0x1 + 0xd6]
008e560c : PUSH EDI
008e560d : CALL 0x00a0d580
008e5612 : CALL dword ptr [0x00b85598]
008e5618 : MOV dword ptr [ESI + 0x9c],EAX
008e561e : MOV dword ptr [EBP + -0x4],0xffffffff
008e5625 : LEA ECX,[EBP + 0xfffffcb0]
008e562b : CALL 0x00406560
008e5630 : MOV ECX,dword ptr [EBP + -0xc]
008e5633 : MOV dword ptr FS:[0x0],ECX
008e563a : POP ECX
008e563b : POP EDI
008e563c : POP ESI
008e563d : POP EBX
008e563e : MOV ECX,dword ptr [EBP + -0x14]
008e5641 : XOR ECX,EBP
008e5643 : CALL 0x00633e6b
008e5648 : MOV ESP,EBP
008e564a : POP EBP
008e564b : RET 0x4
