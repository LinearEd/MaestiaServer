PROGRAM  : Maestia.exe
FUNCTION : __filwbuf
ENTRY    : 0065b7ae
BODY     : [[0065b7ae, 0065b8e6]]

============================================================
DECOMPILED C CODE
============================================================

/* Library Function - Single Match
    __filwbuf
   
   Library: Visual Studio 2008 Release */

int __cdecl __filwbuf(FILE *_File)

{
  ushort uVar1;
  int *piVar2;
  int iVar3;
  uint uVar4;
  undefined *puVar5;
  char *_DstBuf;
  
  if (_File == (FILE *)0x0) {
    piVar2 = __errno();
    *piVar2 = 0x16;
    __invalid_parameter(0,0,0,0,0);
  }
  else {
    uVar4 = _File->_flag;
    if (((uVar4 & 0x83) != 0) && ((uVar4 & 0x40) == 0)) {
      if ((uVar4 & 2) == 0) {
        _File->_flag = uVar4 | 1;
        if ((uVar4 & 0x10c) == 0) {
          __getbuf(_File);
        }
        else {
          _File->_ptr = _File->_base;
        }
        uVar4 = _File->_bufsiz;
        _DstBuf = _File->_base;
        iVar3 = __fileno(_File);
        iVar3 = __read(iVar3,_DstBuf,uVar4);
        _File->_cnt = iVar3;
        if (((iVar3 != 0) && (iVar3 != 1)) && (iVar3 != -1)) {
          if ((_File->_flag & 0x82) == 0) {
            iVar3 = __fileno(_File);
            if ((iVar3 == -1) || (iVar3 = __fileno(_File), iVar3 == -2)) {
              puVar5 = &DAT_00d677f0;
            }
            else {
              iVar3 = __fileno(_File);
              uVar4 = __fileno(_File);
              puVar5 = (undefined *)((uVar4 & 0x1f) * 0x40 + (&DAT_01728c40)[iVar3 >> 5]);
            }
            if ((puVar5[4] & 0x82) == 0x82) {
              _File->_flag = _File->_flag | 0x2000;
            }
          }
          if (((_File->_bufsiz == 0x200) && ((_File->_flag & 8U) != 0)) &&
             ((_File->_flag & 0x400U) == 0)) {
            _File->_bufsiz = 0x1000;
          }
          _File->_cnt = _File->_cnt + -2;
          uVar1 = *(ushort *)_File->_ptr;
          _File->_ptr = (char *)((int)_File->_ptr + 2);
          return (uint)uVar1;
        }
        _File->_flag = _File->_flag | (-(uint)(iVar3 != 0) & 0x10) + 0x10;
        _File->_cnt = 0;
      }
      else {
        _File->_flag = uVar4 | 0x20;
      }
    }
  }
  return 0xffff;
}



============================================================
DISASSEMBLY
============================================================
0065b7ae : MOV EDI,EDI
0065b7b0 : PUSH EBP
0065b7b1 : MOV EBP,ESP
0065b7b3 : PUSH ESI
0065b7b4 : MOV ESI,dword ptr [EBP + 0x8]
0065b7b7 : PUSH EDI
0065b7b8 : XOR EDI,EDI
0065b7ba : CMP ESI,EDI
0065b7bc : JNZ 0x0065b7db
0065b7be : CALL 0x0063ab82
0065b7c3 : PUSH EDI
0065b7c4 : PUSH EDI
0065b7c5 : PUSH EDI
0065b7c6 : PUSH EDI
0065b7c7 : PUSH EDI
0065b7c8 : MOV dword ptr [EAX],0x16
0065b7ce : CALL 0x006372b8
0065b7d3 : ADD ESP,0x14
0065b7d6 : JMP 0x0065b8de
0065b7db : MOV EAX,dword ptr [ESI + 0xc]
0065b7de : TEST AL,0x83
0065b7e0 : JZ 0x0065b8de
0065b7e6 : TEST AL,0x40
0065b7e8 : JNZ 0x0065b8de
0065b7ee : TEST AL,0x2
0065b7f0 : JZ 0x0065b7fd
0065b7f2 : OR EAX,0x20
0065b7f5 : MOV dword ptr [ESI + 0xc],EAX
0065b7f8 : JMP 0x0065b8de
0065b7fd : OR EAX,0x1
0065b800 : MOV dword ptr [ESI + 0xc],EAX
0065b803 : TEST EAX,0x10c
0065b808 : JNZ 0x0065b813
0065b80a : PUSH ESI
0065b80b : CALL 0x0065bd15
0065b810 : POP ECX
0065b811 : JMP 0x0065b818
0065b813 : MOV EAX,dword ptr [ESI + 0x8]
0065b816 : MOV dword ptr [ESI],EAX
0065b818 : PUSH dword ptr [ESI + 0x18]
0065b81b : PUSH dword ptr [ESI + 0x8]
0065b81e : PUSH ESI
0065b81f : CALL 0x0064dfc6
0065b824 : POP ECX
0065b825 : PUSH EAX
0065b826 : CALL 0x00653be6
0065b82b : ADD ESP,0xc
0065b82e : MOV dword ptr [ESI + 0x4],EAX
0065b831 : CMP EAX,EDI
0065b833 : JZ 0x0065b8ce
0065b839 : CMP EAX,0x1
0065b83c : JZ 0x0065b8ce
0065b842 : CMP EAX,-0x1
0065b845 : JZ 0x0065b8ce
0065b84b : TEST byte ptr [ESI + 0xc],0x82
0065b84f : JNZ 0x0065b8a0
0065b851 : PUSH ESI
0065b852 : CALL 0x0064dfc6
0065b857 : POP ECX
0065b858 : CMP EAX,-0x1
0065b85b : JZ 0x0065b88b
0065b85d : PUSH ESI
0065b85e : CALL 0x0064dfc6
0065b863 : POP ECX
0065b864 : CMP EAX,-0x2
0065b867 : JZ 0x0065b88b
0065b869 : PUSH ESI
0065b86a : CALL 0x0064dfc6
0065b86f : SAR EAX,0x5
0065b872 : PUSH ESI
0065b873 : LEA EDI,[EAX*0x4 + 0x1728c40]
0065b87a : CALL 0x0064dfc6
0065b87f : AND EAX,0x1f
0065b882 : POP ECX
0065b883 : SHL EAX,0x6
0065b886 : ADD EAX,dword ptr [EDI]
0065b888 : POP ECX
0065b889 : JMP 0x0065b890
0065b88b : MOV EAX,0xd677f0
0065b890 : MOV AL,byte ptr [EAX + 0x4]
0065b893 : AND AL,0x82
0065b895 : CMP AL,0x82
0065b897 : JNZ 0x0065b8a0
0065b899 : OR dword ptr [ESI + 0xc],0x2000
0065b8a0 : CMP dword ptr [ESI + 0x18],0x200
0065b8a7 : JNZ 0x0065b8be
0065b8a9 : MOV EAX,dword ptr [ESI + 0xc]
0065b8ac : TEST AL,0x8
0065b8ae : JZ 0x0065b8be
0065b8b0 : TEST EAX,0x400
0065b8b5 : JNZ 0x0065b8be
0065b8b7 : MOV dword ptr [ESI + 0x18],0x1000
0065b8be : MOV ECX,dword ptr [ESI]
0065b8c0 : ADD dword ptr [ESI + 0x4],-0x2
0065b8c4 : MOVZX EAX,word ptr [ECX]
0065b8c7 : ADD ECX,0x2
0065b8ca : MOV dword ptr [ESI],ECX
0065b8cc : JMP 0x0065b8e3
0065b8ce : NEG EAX
0065b8d0 : SBB EAX,EAX
0065b8d2 : AND EAX,0x10
0065b8d5 : ADD EAX,0x10
0065b8d8 : OR dword ptr [ESI + 0xc],EAX
0065b8db : MOV dword ptr [ESI + 0x4],EDI
0065b8de : MOV EAX,0xffff
0065b8e3 : POP EDI
0065b8e4 : POP ESI
0065b8e5 : POP EBP
0065b8e6 : RET
