PROGRAM  : Maestia.exe
FUNCTION : FUN_00a4d4b0
ENTRY    : 00a4d4b0
BODY     : [[00a4d4b0, 00a4d846]]

============================================================
DECOMPILED C CODE
============================================================

void FUN_00a4d4b0(void)

{
  int ctx;
  char cVar1;
  wchar_t *_Source;
  int iVar2;
  int in_ECX;
  undefined4 uVar3;
  byte bVar4;
  uint8_t *packet;
  uint uStack_38;
  uint uStack_1c;
  void *local_14;
  undefined1 *puStack_10;
  int local_c;
  
  local_c = 0xffffffff;
  puStack_10 = &LAB_00b3b217;
  local_14 = ExceptionList;
  ExceptionList = &local_14;
  if (*(char *)(in_ECX + 0x344) == '\0') {
    if (*(int *)(in_ECX + 0x154) == 0) {
      if (*(int **)(in_ECX + 0x4c) != (int *)0x0) {
        (**(code **)(**(int **)(in_ECX + 0x4c) + 0x10))();
      }
      FUN_00406460();
      local_c = 0;
      FUN_0081d120();
      local_c._0_1_ = 1;
      FUN_008ede80();
      local_c = (uint)local_c._1_3_ << 8;
      if (7 < uStack_1c) {
                    /* WARNING: Subroutine does not return */
        FUN_006f04e0();
      }
      local_c = 0xffffffff;
      if (7 < uStack_38) {
                    /* WARNING: Subroutine does not return */
        FUN_006f04e0();
      }
      ExceptionList = local_14;
      return;
    }
    FUN_00a4a8a0();
    FUN_00a4a440();
    FUN_00a4bf10();
    FUN_00a4beb0();
    FUN_00a4be50();
    FUN_00a4bdf0();
    iVar2 = *(int *)ThreadLocalStoragePointer;
    bVar4 = (byte)((ulonglong)(*(byte *)(iVar2 + 0x18) + 1) % 3);
    *(byte *)(iVar2 + 0x18) = bVar4;
    packet = (uint8_t *)((uint)bVar4 * 0x2000 + 0x122cb8 + iVar2);
    if (packet == (uint8_t *)0x0) {
      packet = (uint8_t *)0x0;
    }
    else {
      packet[0] = '\0';
      packet[1] = '\0';
      packet[2] = '3';
      packet[3] = ')';
    }
    local_c = 0xffffffff;
    if (*(uint *)(in_ECX + 0x158) < 8) {
      _Source = (wchar_t *)(in_ECX + 0x144);
    }
    else {
      _Source = *(wchar_t **)(in_ECX + 0x144);
    }
    _wcsncpy((wchar_t *)(packet + 0xc),_Source,0x27);
    packet[0x5a] = '\0';
    packet[0x5b] = '\0';
    iVar2 = FUN_00a49990();
    if (iVar2 == 0) {
      uVar3 = 0;
    }
    else {
      uVar3 = CONCAT22(*(undefined2 *)(iVar2 + 4),*(undefined2 *)(iVar2 + 6));
    }
    *(undefined4 *)(packet + 4) = uVar3;
    *(undefined2 *)(packet + 0x5c) = *(undefined2 *)(in_ECX + 0x292);
    *(undefined2 *)(packet + 0x5e) = *(undefined2 *)(in_ECX + 0x290);
    *(undefined4 *)(packet + 0x70) = *(undefined4 *)(in_ECX + 0x29c);
    *(undefined4 *)(packet + 0x74) = *(undefined4 *)(in_ECX + 0x2a4);
    *(undefined4 *)(packet + 0x78) = *(undefined4 *)(in_ECX + 0x2a8);
    *(undefined4 *)(packet + 0x7c) = *(undefined4 *)(in_ECX + 0x2a0);
    if ((*(int *)(in_ECX + 0x54) == 0) ||
       (iVar2 = *(int *)(*(int *)(in_ECX + 0x54) + 0x18b4), iVar2 == 0)) {
      uVar3 = 5;
      packet[0x68] = '\x05';
      packet[0x69] = '\0';
      packet[0x6a] = '\0';
      packet[0x6b] = '\0';
      packet[0x6c] = '\x05';
      packet[0x6d] = '\0';
      packet[0x6e] = '\0';
      packet[0x6f] = '\0';
      packet[0x60] = '\x05';
      packet[0x61] = '\0';
      packet[0x62] = '\0';
      packet[99] = '\0';
    }
    else {
      *(undefined4 *)(packet + 0x68) = *(undefined4 *)(iVar2 + 0x24);
      *(undefined4 *)(packet + 0x6c) =
           *(undefined4 *)(*(int *)(*(int *)(in_ECX + 0x54) + 0x18b4) + 0x28);
      *(undefined4 *)(packet + 0x60) =
           *(undefined4 *)(*(int *)(*(int *)(in_ECX + 0x54) + 0x18b4) + 0x2c);
      uVar3 = *(undefined4 *)(*(int *)(*(int *)(in_ECX + 0x54) + 0x18b4) + 0x30);
    }
    *(undefined4 *)(packet + 100) = uVar3;
    *(undefined4 *)(in_ECX + 0x2d0) = *(undefined4 *)(in_ECX + 0x15c);
    packet[0x80] = (uint8_t)*(undefined4 *)(in_ECX + 0x15c);
    iVar2 = FUN_00703c00();
    if (iVar2 == 0) {
      packet[8] = '\0';
      packet[9] = '\0';
      packet[10] = '\0';
      packet[0xb] = '\0';
    }
    else {
      *(uint *)(packet + 8) = CONCAT22(*(undefined2 *)(iVar2 + 4),*(undefined2 *)(iVar2 + 6));
    }
    FUN_00405eb0(in_ECX + 0x140,0,0xffffffff);
    local_c = 0xffffffff;
    cVar1 = FUN_0081c5e0();
    iVar2 = DAT_017247d4;
    if (cVar1 == '\0') {
      FUN_00406460();
      local_c = 4;
      FUN_0081d120();
      local_c._0_1_ = 5;
      FUN_008ede80();
      local_c = CONCAT31(local_c._1_3_,4);
      FUN_00406560();
      local_c = 0xffffffff;
      FUN_00406560();
    }
    else {
      *(undefined1 *)(in_ECX + 0x344) = 1;
      ctx = *(int *)(iVar2 + 4);
      if ((ctx != 0) && (*(char *)(iVar2 + 8) != '\0')) {
        FUN_00a0dd40(ctx,0x81,packet);
        ExceptionList = local_14;
        return;
      }
    }
  }
  ExceptionList = local_14;
  return;
}



============================================================
DISASSEMBLY
============================================================
00a4d4b0 : PUSH EBP
00a4d4b1 : MOV EBP,ESP
00a4d4b3 : AND ESP,0xfffffff8
00a4d4b6 : PUSH -0x1
00a4d4b8 : PUSH 0xb3b217
00a4d4bd : MOV EAX,FS:[0x0]
00a4d4c3 : PUSH EAX
00a4d4c4 : SUB ESP,0x40
00a4d4c7 : PUSH EBX
00a4d4c8 : PUSH ESI
00a4d4c9 : PUSH EDI
00a4d4ca : MOV EAX,[0x00d66fa0]
00a4d4cf : XOR EAX,ESP
00a4d4d1 : PUSH EAX
00a4d4d2 : LEA EAX,[ESP + 0x50]
00a4d4d6 : MOV FS:[0x0],EAX
00a4d4dc : MOV ESI,ECX
00a4d4de : CMP byte ptr [ESI + 0x344],0x0
00a4d4e5 : JNZ 0x00a4d834
00a4d4eb : CMP dword ptr [ESI + 0x154],0x0
00a4d4f2 : JNZ 0x00a4d5ae
00a4d4f8 : MOV ESI,dword ptr [ESI + 0x4c]
00a4d4fb : TEST ESI,ESI
00a4d4fd : JZ 0x00a4d508
00a4d4ff : MOV EAX,dword ptr [ESI]
00a4d501 : MOV EDX,dword ptr [EAX + 0x10]
00a4d504 : MOV ECX,ESI
00a4d506 : CALL EDX
00a4d508 : PUSH 0xcc74b8
00a4d50d : LEA ECX,[ESP + 0x18]
00a4d511 : CALL 0x00406460
00a4d516 : MOV dword ptr [ESP + 0x58],0x0
00a4d51e : MOV ECX,dword ptr [0x0172491c]
00a4d524 : LEA EAX,[ESP + 0x14]
00a4d528 : PUSH EAX
00a4d529 : LEA EDI,[ESP + 0x34]
00a4d52d : CALL 0x0081d120
00a4d532 : MOV byte ptr [ESP + 0x58],0x1
00a4d537 : MOV ECX,dword ptr [0x00da9894]
00a4d53d : MOV ECX,dword ptr [ECX]
00a4d53f : XOR EDI,EDI
00a4d541 : PUSH EDI
00a4d542 : PUSH EAX
00a4d543 : CALL 0x008ede80
00a4d548 : MOV byte ptr [ESP + 0x58],0x0
00a4d54d : MOV ESI,0x8
00a4d552 : CMP dword ptr [ESP + 0x48],ESI
00a4d556 : JC 0x00a4d561
00a4d558 : MOV ECX,dword ptr [ESP + 0x34]
00a4d55c : CALL 0x006f04e0
00a4d561 : MOV EBX,0x7
00a4d566 : XOR EDX,EDX
00a4d568 : MOV dword ptr [ESP + 0x48],EBX
00a4d56c : MOV dword ptr [ESP + 0x44],EDI
00a4d570 : MOV word ptr [ESP + 0x34],DX
00a4d575 : MOV dword ptr [ESP + 0x58],0xffffffff
00a4d57d : CMP dword ptr [ESP + 0x2c],ESI
00a4d581 : JC 0x00a4d58c
00a4d583 : MOV ECX,dword ptr [ESP + 0x18]
00a4d587 : CALL 0x006f04e0
00a4d58c : XOR EAX,EAX
00a4d58e : MOV dword ptr [ESP + 0x2c],EBX
00a4d592 : MOV dword ptr [ESP + 0x28],EDI
00a4d596 : MOV word ptr [ESP + 0x18],AX
00a4d59b : MOV ECX,dword ptr [ESP + 0x50]
00a4d59f : MOV dword ptr FS:[0x0],ECX
00a4d5a6 : POP ECX
00a4d5a7 : POP EDI
00a4d5a8 : POP ESI
00a4d5a9 : POP EBX
00a4d5aa : MOV ESP,EBP
00a4d5ac : POP EBP
00a4d5ad : RET
00a4d5ae : PUSH ESI
00a4d5af : CALL 0x00a4a8a0
00a4d5b4 : PUSH ESI
00a4d5b5 : CALL 0x00a4a440
00a4d5ba : CALL 0x00a4bf10
00a4d5bf : MOV EAX,ESI
00a4d5c1 : CALL 0x00a4beb0
00a4d5c6 : MOV EAX,ESI
00a4d5c8 : CALL 0x00a4be50
00a4d5cd : MOV EAX,ESI
00a4d5cf : CALL 0x00a4bdf0
00a4d5d4 : MOV ECX,dword ptr FS:[0x2c]
00a4d5db : MOV ECX,dword ptr [ECX]
00a4d5dd : MOVZX EAX,byte ptr [ECX + 0x18]
00a4d5e1 : INC EAX
00a4d5e2 : CDQ
00a4d5e3 : MOV EDI,0x3
00a4d5e8 : IDIV EDI
00a4d5ea : MOV byte ptr [ECX + 0x18],DL
00a4d5ed : MOVZX EDX,DL
00a4d5f0 : SHL EDX,0xd
00a4d5f3 : LEA EBX,[EDX + ECX*0x1 + 0x122cb8]
00a4d5fa : MOV dword ptr [ESP + 0x10],EBX
00a4d5fe : MOV dword ptr [ESP + 0x58],0x2
00a4d606 : TEST EBX,EBX
00a4d608 : JZ 0x00a4d619
00a4d60a : XOR EAX,EAX
00a4d60c : MOV word ptr [EBX],AX
00a4d60f : MOV byte ptr [EBX + 0x2],0x33
00a4d613 : MOV byte ptr [EBX + 0x3],0x29
00a4d617 : JMP 0x00a4d61b
00a4d619 : XOR EBX,EBX
00a4d61b : MOV dword ptr [ESP + 0x58],0xffffffff
00a4d623 : CMP dword ptr [ESI + 0x158],0x8
00a4d62a : JC 0x00a4d634
00a4d62c : MOV EAX,dword ptr [ESI + 0x144]
00a4d632 : JMP 0x00a4d63a
00a4d634 : LEA EAX,[ESI + 0x144]
00a4d63a : PUSH 0x27
00a4d63c : PUSH EAX
00a4d63d : LEA EDI,[EBX + 0xc]
00a4d640 : PUSH EDI
00a4d641 : CALL 0x00634e39
00a4d646 : XOR ECX,ECX
00a4d648 : MOV word ptr [EDI + 0x4e],CX
00a4d64c : MOV DL,byte ptr [ESI + 0x1e0]
00a4d652 : MOVZX EAX,word ptr [ESI + 0x168]
00a4d659 : MOV byte ptr [ESP + 0x1c],DL
00a4d65d : MOV ECX,dword ptr [ESP + 0x1c]
00a4d661 : ADD ESP,0xc
00a4d664 : PUSH ECX
00a4d665 : PUSH EAX
00a4d666 : CALL 0x00a49990
00a4d66b : ADD ESP,0x8
00a4d66e : TEST EAX,EAX
00a4d670 : JZ 0x00a4d681
00a4d672 : MOVZX ECX,word ptr [EAX + 0x4]
00a4d676 : MOVZX EDX,word ptr [EAX + 0x6]
00a4d67a : SHL ECX,0x10
00a4d67d : OR ECX,EDX
00a4d67f : JMP 0x00a4d683
00a4d681 : XOR ECX,ECX
00a4d683 : MOV dword ptr [EBX + 0x4],ECX
00a4d686 : MOV AX,word ptr [ESI + 0x292]
00a4d68d : MOV word ptr [EBX + 0x5c],AX
00a4d691 : MOV CX,word ptr [ESI + 0x290]
00a4d698 : MOV word ptr [EBX + 0x5e],CX
00a4d69c : MOV EDX,dword ptr [ESI + 0x29c]
00a4d6a2 : MOV dword ptr [EBX + 0x70],EDX
00a4d6a5 : MOV EAX,dword ptr [ESI + 0x2a4]
00a4d6ab : MOV dword ptr [EBX + 0x74],EAX
00a4d6ae : MOV ECX,dword ptr [ESI + 0x2a8]
00a4d6b4 : MOV dword ptr [EBX + 0x78],ECX
00a4d6b7 : MOV EDX,dword ptr [ESI + 0x2a0]
00a4d6bd : MOV dword ptr [EBX + 0x7c],EDX
00a4d6c0 : MOV EAX,dword ptr [ESI + 0x54]
00a4d6c3 : TEST EAX,EAX
00a4d6c5 : JZ 0x00a4d703
00a4d6c7 : MOV EAX,dword ptr [EAX + 0x18b4]
00a4d6cd : TEST EAX,EAX
00a4d6cf : JZ 0x00a4d703
00a4d6d1 : MOV EAX,dword ptr [EAX + 0x24]
00a4d6d4 : MOV dword ptr [EBX + 0x68],EAX
00a4d6d7 : MOV EAX,dword ptr [ESI + 0x54]
00a4d6da : MOV EAX,dword ptr [EAX + 0x18b4]
00a4d6e0 : MOV EAX,dword ptr [EAX + 0x28]
00a4d6e3 : MOV dword ptr [EBX + 0x6c],EAX
00a4d6e6 : MOV ECX,dword ptr [ESI + 0x54]
00a4d6e9 : MOV EAX,dword ptr [ECX + 0x18b4]
00a4d6ef : MOV EAX,dword ptr [EAX + 0x2c]
00a4d6f2 : MOV dword ptr [EBX + 0x60],EAX
00a4d6f5 : MOV EDX,dword ptr [ESI + 0x54]
00a4d6f8 : MOV EAX,dword ptr [EDX + 0x18b4]
00a4d6fe : MOV EAX,dword ptr [EAX + 0x30]
00a4d701 : JMP 0x00a4d711
00a4d703 : MOV EAX,0x5
00a4d708 : MOV dword ptr [EBX + 0x68],EAX
00a4d70b : MOV dword ptr [EBX + 0x6c],EAX
00a4d70e : MOV dword ptr [EBX + 0x60],EAX
00a4d711 : MOV dword ptr [EBX + 0x64],EAX
00a4d714 : MOV EAX,dword ptr [ESI + 0x15c]
00a4d71a : MOV CL,AL
00a4d71c : MOV dword ptr [ESI + 0x2d0],EAX
00a4d722 : MOV byte ptr [EBX + 0x80],CL
00a4d728 : MOVZX EDI,word ptr [ESI + 0x214]
00a4d72f : INC DI
00a4d731 : PUSH 0x1000
00a4d736 : CALL 0x00703c00
00a4d73b : XOR EDI,EDI
00a4d73d : ADD ESP,0x4
00a4d740 : CMP EAX,EDI
00a4d742 : JZ 0x00a4d756
00a4d744 : MOVZX EDX,word ptr [EAX + 0x4]
00a4d748 : MOVZX EAX,word ptr [EAX + 0x6]
00a4d74c : SHL EDX,0x10
00a4d74f : OR EDX,EAX
00a4d751 : MOV dword ptr [EBX + 0x8],EDX
00a4d754 : JMP 0x00a4d759
00a4d756 : MOV dword ptr [EBX + 0x8],EDI
00a4d759 : SUB ESP,0x1c
00a4d75c : MOV ECX,ESP
00a4d75e : MOV dword ptr [ESP + 0x2c],ESP
00a4d762 : PUSH -0x1
00a4d764 : PUSH EDI
00a4d765 : LEA EAX,[ESI + 0x140]
00a4d76b : XOR EDX,EDX
00a4d76d : MOV dword ptr [ECX + 0x18],0x7
00a4d774 : MOV dword ptr [ECX + 0x14],EDI
00a4d777 : PUSH EAX
00a4d778 : MOV word ptr [ECX + 0x4],DX
00a4d77c : CALL 0x00405eb0
00a4d781 : MOV dword ptr [ESP + 0x74],0x3
00a4d789 : MOV dword ptr [ESP + 0x74],0xffffffff
00a4d791 : CALL 0x0081c5e0
00a4d796 : TEST AL,AL
00a4d798 : JZ 0x00a4d7d8
00a4d79a : MOV ECX,dword ptr [0x017247d4]
00a4d7a0 : MOV byte ptr [ESI + 0x344],0x1
00a4d7a7 : MOV EAX,dword ptr [ECX + 0x4]
00a4d7aa : CMP EAX,EDI
00a4d7ac : JZ 0x00a4d834
00a4d7b2 : CMP byte ptr [ECX + 0x8],0x0
00a4d7b6 : JZ 0x00a4d834
00a4d7b8 : PUSH 0x81
00a4d7bd : PUSH EAX
00a4d7be : MOV EDI,EBX
00a4d7c0 : CALL 0x00a0dd40
00a4d7c5 : MOV ECX,dword ptr [ESP + 0x50]
00a4d7c9 : MOV dword ptr FS:[0x0],ECX
00a4d7d0 : POP ECX
00a4d7d1 : POP EDI
00a4d7d2 : POP ESI
00a4d7d3 : POP EBX
00a4d7d4 : MOV ESP,EBP
00a4d7d6 : POP EBP
00a4d7d7 : RET
00a4d7d8 : PUSH 0xcc74ec
00a4d7dd : LEA ECX,[ESP + 0x34]
00a4d7e1 : CALL 0x00406460
00a4d7e6 : MOV EBX,0x4
00a4d7eb : MOV dword ptr [ESP + 0x58],EBX
00a4d7ef : MOV ECX,dword ptr [0x0172491c]
00a4d7f5 : LEA EAX,[ESP + 0x30]
00a4d7f9 : PUSH EAX
00a4d7fa : LEA EDI,[ESP + 0x18]
00a4d7fe : CALL 0x0081d120
00a4d803 : MOV byte ptr [ESP + 0x58],0x5
00a4d808 : MOV ECX,dword ptr [0x00da9894]
00a4d80e : MOV ECX,dword ptr [ECX]
00a4d810 : PUSH 0x0
00a4d812 : PUSH EAX
00a4d813 : CALL 0x008ede80
00a4d818 : MOV byte ptr [ESP + 0x58],BL
00a4d81c : MOV ECX,EDI
00a4d81e : CALL 0x00406560
00a4d823 : MOV dword ptr [ESP + 0x58],0xffffffff
00a4d82b : LEA ECX,[ESP + 0x30]
00a4d82f : CALL 0x00406560
00a4d834 : MOV ECX,dword ptr [ESP + 0x50]
00a4d838 : MOV dword ptr FS:[0x0],ECX
00a4d83f : POP ECX
00a4d840 : POP EDI
00a4d841 : POP ESI
00a4d842 : POP EBX
00a4d843 : MOV ESP,EBP
00a4d845 : POP EBP
00a4d846 : RET
