PROGRAM  : Maestia.exe
FUNCTION : __setmbcp_nolock
ENTRY    : 0065117b
BODY     : [[0065117b, 0065135f]]

============================================================
DECOMPILED C CODE
============================================================

/* Library Function - Single Match
    __setmbcp_nolock
   
   Library: Visual Studio 2008 Release */

void __setmbcp_nolock(undefined4 param_1,int param_2)

{
  BYTE *pBVar1;
  byte *pbVar2;
  byte bVar3;
  uint uVar4;
  uint uVar5;
  BOOL BVar6;
  undefined2 *puVar7;
  byte *pbVar8;
  int extraout_ECX;
  undefined2 *puVar9;
  int iVar10;
  undefined4 extraout_EDX;
  BYTE *pBVar11;
  threadmbcinfostruct *unaff_EDI;
  uint local_24;
  byte *local_20;
  _cpinfo local_1c;
  uint local_8;
  
  local_8 = DAT_00d66fa0 ^ (uint)&stack0xfffffffc;
  uVar4 = getSystemCP((int)unaff_EDI);
  if (uVar4 != 0) {
    local_20 = (byte *)0x0;
    uVar5 = 0;
LAB_006511b9:
    if (*(uint *)((int)&DAT_00d67c60 + uVar5) != uVar4) goto code_r0x006511c5;
    _memset((void *)(param_2 + 0x1c),0,0x101);
    local_24 = 0;
    pbVar8 = &DAT_00d67c70 + (int)local_20 * 0x30;
    local_20 = pbVar8;
    do {
      for (; (*pbVar8 != 0 && (bVar3 = pbVar8[1], bVar3 != 0)); pbVar8 = pbVar8 + 2) {
        for (uVar5 = (uint)*pbVar8; uVar5 <= bVar3; uVar5 = uVar5 + 1) {
          pbVar2 = (byte *)(param_2 + 0x1d + uVar5);
          *pbVar2 = *pbVar2 | *(byte *)(local_24 + 0xd67c5c);
          bVar3 = pbVar8[1];
        }
      }
      local_24 = local_24 + 1;
      pbVar8 = local_20 + 8;
      local_20 = pbVar8;
    } while (local_24 < 4);
    *(uint *)(param_2 + 4) = uVar4;
    *(undefined4 *)(param_2 + 8) = 1;
    iVar10 = CPtoLCID((int)unaff_EDI);
    *(int *)(param_2 + 0xc) = iVar10;
    puVar7 = (undefined2 *)(param_2 + 0x10);
    puVar9 = (undefined2 *)(&DAT_00d67c64 + extraout_ECX);
    iVar10 = 6;
    do {
      *puVar7 = *puVar9;
      puVar9 = puVar9 + 1;
      puVar7 = puVar7 + 1;
      iVar10 = iVar10 + -1;
    } while (iVar10 != 0);
    goto LAB_006512ea;
  }
LAB_006511a6:
  setSBCS(unaff_EDI);
LAB_00651351:
  __security_check_cookie(local_8 ^ (uint)&stack0xfffffffc);
  return;
code_r0x006511c5:
  local_20 = (byte *)((int)local_20 + 1);
  uVar5 = uVar5 + 0x30;
  if (0xef < uVar5) goto code_r0x006511d2;
  goto LAB_006511b9;
code_r0x006511d2:
  if (((uVar4 == 65000) || (uVar4 == 0xfde9)) ||
     (BVar6 = IsValidCodePage(uVar4 & 0xffff), BVar6 == 0)) goto LAB_00651351;
  BVar6 = GetCPInfo(uVar4,&local_1c);
  if (BVar6 != 0) {
    _memset((void *)(param_2 + 0x1c),0,0x101);
    *(uint *)(param_2 + 4) = uVar4;
    *(undefined4 *)(param_2 + 0xc) = 0;
    if (local_1c.MaxCharSize < 2) {
      *(undefined4 *)(param_2 + 8) = 0;
    }
    else {
      if (local_1c.LeadByte[0] != '\0') {
        pBVar11 = local_1c.LeadByte + 1;
        do {
          bVar3 = *pBVar11;
          if (bVar3 == 0) break;
          for (uVar4 = (uint)pBVar11[-1]; uVar4 <= bVar3; uVar4 = uVar4 + 1) {
            pbVar8 = (byte *)(param_2 + 0x1d + uVar4);
            *pbVar8 = *pbVar8 | 4;
          }
          pBVar1 = pBVar11 + 1;
          pBVar11 = pBVar11 + 2;
        } while (*pBVar1 != 0);
      }
      pbVar8 = (byte *)(param_2 + 0x1e);
      iVar10 = 0xfe;
      do {
        *pbVar8 = *pbVar8 | 8;
        pbVar8 = pbVar8 + 1;
        iVar10 = iVar10 + -1;
      } while (iVar10 != 0);
      iVar10 = CPtoLCID((int)unaff_EDI);
      *(int *)(param_2 + 0xc) = iVar10;
      *(undefined4 *)(param_2 + 8) = extraout_EDX;
    }
    *(undefined4 *)(param_2 + 0x10) = 0;
    *(undefined4 *)(param_2 + 0x14) = 0;
    *(undefined4 *)(param_2 + 0x18) = 0;
LAB_006512ea:
    setSBUpLow(unaff_EDI);
    goto LAB_00651351;
  }
  if (DAT_00d7c0ac == 0) goto LAB_00651351;
  goto LAB_006511a6;
}



============================================================
DISASSEMBLY
============================================================
0065117b : MOV EDI,EDI
0065117d : PUSH EBP
0065117e : MOV EBP,ESP
00651180 : SUB ESP,0x20
00651183 : MOV EAX,[0x00d66fa0]
00651188 : XOR EAX,EBP
0065118a : MOV dword ptr [EBP + -0x4],EAX
0065118d : PUSH EBX
0065118e : MOV EBX,dword ptr [EBP + 0xc]
00651191 : PUSH ESI
00651192 : MOV ESI,dword ptr [EBP + 0x8]
00651195 : PUSH EDI
00651196 : CALL 0x006510ff
0065119b : MOV EDI,EAX
0065119d : XOR ESI,ESI
0065119f : MOV dword ptr [EBP + 0x8],EDI
006511a2 : CMP EDI,ESI
006511a4 : JNZ 0x006511b4
006511a6 : MOV EAX,EBX
006511a8 : CALL 0x00650e64
006511ad : XOR EAX,EAX
006511af : JMP 0x00651351
006511b4 : MOV dword ptr [EBP + -0x1c],ESI
006511b7 : XOR EAX,EAX
006511b9 : CMP dword ptr [EAX + 0xd67c60],EDI
006511bf : JZ 0x00651256
006511c5 : INC dword ptr [EBP + -0x1c]
006511c8 : ADD EAX,0x30
006511cb : CMP EAX,0xf0
006511d0 : JC 0x006511b9
006511d2 : CMP EDI,0xfde8
006511d8 : JZ 0x0065134e
006511de : CMP EDI,0xfde9
006511e4 : JZ 0x0065134e
006511ea : MOVZX EAX,DI
006511ed : PUSH EAX
006511ee : CALL dword ptr [0x00b85358]
006511f4 : TEST EAX,EAX
006511f6 : JZ 0x0065134e
006511fc : LEA EAX,[EBP + -0x18]
006511ff : PUSH EAX
00651200 : PUSH EDI
00651201 : CALL dword ptr [0x00b8529c]
00651207 : TEST EAX,EAX
00651209 : JZ 0x00651342
0065120f : PUSH 0x101
00651214 : LEA EAX,[EBX + 0x1c]
00651217 : PUSH ESI
00651218 : PUSH EAX
00651219 : CALL 0x0063b700
0065121e : XOR EDX,EDX
00651220 : INC EDX
00651221 : ADD ESP,0xc
00651224 : MOV dword ptr [EBX + 0x4],EDI
00651227 : MOV dword ptr [EBX + 0xc],ESI
0065122a : CMP dword ptr [EBP + -0x18],EDX
0065122d : JBE 0x0065132b
00651233 : CMP byte ptr [EBP + -0x12],0x0
00651237 : JZ 0x0065130c
0065123d : LEA ESI,[EBP + -0x11]
00651240 : MOV CL,byte ptr [ESI]
00651242 : TEST CL,CL
00651244 : JZ 0x0065130c
0065124a : MOVZX EAX,byte ptr [ESI + -0x1]
0065124e : MOVZX ECX,CL
00651251 : JMP 0x006512fc
00651256 : PUSH 0x101
0065125b : LEA EAX,[EBX + 0x1c]
0065125e : PUSH ESI
0065125f : PUSH EAX
00651260 : CALL 0x0063b700
00651265 : MOV ECX,dword ptr [EBP + -0x1c]
00651268 : ADD ESP,0xc
0065126b : IMUL ECX,ECX,0x30
0065126e : MOV dword ptr [EBP + -0x20],ESI
00651271 : LEA ESI,[ECX + 0xd67c70]
00651277 : MOV dword ptr [EBP + -0x1c],ESI
0065127a : JMP 0x006512a6
0065127c : MOV AL,byte ptr [ESI + 0x1]
0065127f : TEST AL,AL
00651281 : JZ 0x006512ab
00651283 : MOVZX EDI,byte ptr [ESI]
00651286 : MOVZX EAX,AL
00651289 : JMP 0x0065129d
0065128b : MOV EAX,dword ptr [EBP + -0x20]
0065128e : MOV AL,byte ptr [EAX + 0xd67c5c]
00651294 : OR byte ptr [EBX + EDI*0x1 + 0x1d],AL
00651298 : MOVZX EAX,byte ptr [ESI + 0x1]
0065129c : INC EDI
0065129d : CMP EDI,EAX
0065129f : JBE 0x0065128b
006512a1 : MOV EDI,dword ptr [EBP + 0x8]
006512a4 : INC ESI
006512a5 : INC ESI
006512a6 : CMP byte ptr [ESI],0x0
006512a9 : JNZ 0x0065127c
006512ab : MOV ESI,dword ptr [EBP + -0x1c]
006512ae : INC dword ptr [EBP + -0x20]
006512b1 : ADD ESI,0x8
006512b4 : CMP dword ptr [EBP + -0x20],0x4
006512b8 : MOV dword ptr [EBP + -0x1c],ESI
006512bb : JC 0x006512a6
006512bd : MOV EAX,EDI
006512bf : MOV dword ptr [EBX + 0x4],EDI
006512c2 : MOV dword ptr [EBX + 0x8],0x1
006512c9 : CALL 0x00650e35
006512ce : PUSH 0x6
006512d0 : MOV dword ptr [EBX + 0xc],EAX
006512d3 : LEA EAX,[EBX + 0x10]
006512d6 : LEA ECX,[ECX + 0xd67c64]
006512dc : POP EDX
006512dd : MOV SI,word ptr [ECX]
006512e0 : INC ECX
006512e1 : MOV word ptr [EAX],SI
006512e4 : INC ECX
006512e5 : INC EAX
006512e6 : INC EAX
006512e7 : DEC EDX
006512e8 : JNZ 0x006512dd
006512ea : MOV ESI,EBX
006512ec : CALL 0x00650ec8
006512f1 : JMP 0x006511ad
006512f6 : OR byte ptr [EBX + EAX*0x1 + 0x1d],0x4
006512fb : INC EAX
006512fc : CMP EAX,ECX
006512fe : JBE 0x006512f6
00651300 : INC ESI
00651301 : INC ESI
00651302 : CMP byte ptr [ESI + -0x1],0x0
00651306 : JNZ 0x00651240
0065130c : LEA EAX,[EBX + 0x1e]
0065130f : MOV ECX,0xfe
00651314 : OR byte ptr [EAX],0x8
00651317 : INC EAX
00651318 : DEC ECX
00651319 : JNZ 0x00651314
0065131b : MOV EAX,dword ptr [EBX + 0x4]
0065131e : CALL 0x00650e35
00651323 : MOV dword ptr [EBX + 0xc],EAX
00651326 : MOV dword ptr [EBX + 0x8],EDX
00651329 : JMP 0x0065132e
0065132b : MOV dword ptr [EBX + 0x8],ESI
0065132e : XOR EAX,EAX
00651330 : MOVZX ECX,AX
00651333 : MOV EAX,ECX
00651335 : SHL ECX,0x10
00651338 : OR EAX,ECX
0065133a : LEA EDI,[EBX + 0x10]
0065133d : STOSD ES:EDI
0065133e : STOSD ES:EDI
0065133f : STOSD ES:EDI
00651340 : JMP 0x006512ea
00651342 : CMP dword ptr [0x00d7c0ac],ESI
00651348 : JNZ 0x006511a6
0065134e : OR EAX,0xffffffff
00651351 : MOV ECX,dword ptr [EBP + -0x4]
00651354 : POP EDI
00651355 : POP ESI
00651356 : XOR ECX,EBP
00651358 : POP EBX
00651359 : CALL 0x00633e6b
0065135e : LEAVE
0065135f : RET
