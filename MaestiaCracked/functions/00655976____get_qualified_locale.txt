PROGRAM  : Maestia.exe
FUNCTION : ___get_qualified_locale
ENTRY    : 00655976
BODY     : [[00655976, 00655b1d] [00655b23, 00655b66]]

============================================================
DECOMPILED C CODE
============================================================

/* Library Function - Single Match
    ___get_qualified_locale
   
   Library: Visual Studio 2008 Release */

BOOL __cdecl ___get_qualified_locale(LPLC_STRINGS _LpInStr,UINT *_LpCodePage,LPLC_STRINGS _LpOutStr)

{
  int *piVar1;
  wchar_t **ppwVar2;
  wchar_t *pwVar3;
  _ptiddata p_Var4;
  size_t sVar5;
  LCID LVar6;
  uint _Value;
  BOOL BVar7;
  errno_t eVar8;
  int iVar9;
  _setloc_struct *p_Var10;
  
  p_Var4 = __getptd();
  p_Var10 = &p_Var4->_setloc_data;
  if (_LpInStr == (LPLC_STRINGS)0x0) {
    piVar1 = &(p_Var4->_setloc_data).iLocState;
    *piVar1 = *piVar1 | 0x104;
LAB_00655a5b:
    LVar6 = GetUserDefaultLCID();
    (p_Var4->_setloc_data)._cachecp = LVar6;
    *(LCID *)(p_Var4->_setloc_data)._cachein = LVar6;
  }
  else {
    pwVar3 = _LpInStr->szLanguage + 0x20;
    ppwVar2 = &(p_Var4->_setloc_data).pchCountry;
    p_Var10->pchLanguage = _LpInStr->szLanguage;
    *ppwVar2 = pwVar3;
    if ((pwVar3 != (wchar_t *)0x0) && ((char)*pwVar3 != '\0')) {
      _TranslateName(&PTR_s_america_00b9c958,0x16,ppwVar2);
    }
    (p_Var4->_setloc_data).iLocState = 0;
    if ((p_Var10->pchLanguage == (wchar_t *)0x0) || ((char)*p_Var10->pchLanguage == '\0')) {
      pwVar3 = *ppwVar2;
      if ((pwVar3 == (wchar_t *)0x0) || ((char)*pwVar3 == '\0')) {
        (p_Var4->_setloc_data).iLocState = 0x104;
        goto LAB_00655a5b;
      }
      sVar5 = _strlen((char *)pwVar3);
      (p_Var4->_setloc_data).bAbbrevCountry = (uint)(sVar5 == 3);
      EnumSystemLocalesA(_CountryEnumProc_4,1);
      if (((p_Var4->_setloc_data).iLocState & 4) == 0) {
        (p_Var4->_setloc_data).iLocState = 0;
      }
    }
    else {
      if ((*ppwVar2 == (wchar_t *)0x0) || ((char)**ppwVar2 == '\0')) {
        _GetLcidFromLanguage();
      }
      else {
        _GetLcidFromLangCountry();
      }
      if ((p_Var4->_setloc_data).iLocState != 0) goto LAB_00655a71;
      iVar9 = _TranslateName(&PTR_s_american_00b9c750,0x40,p_Var10);
      if (iVar9 != 0) {
        if ((*ppwVar2 == (wchar_t *)0x0) || ((char)**ppwVar2 == '\0')) {
          _GetLcidFromLanguage();
        }
        else {
          _GetLcidFromLangCountry();
        }
      }
    }
  }
  if ((p_Var4->_setloc_data).iLocState == 0) {
    return 0;
  }
LAB_00655a71:
  _Value = _ProcessCodePage();
  if ((((_Value == 0) || (_Value == 65000)) || (_Value == 0xfde9)) ||
     ((BVar7 = IsValidCodePage(_Value & 0xffff), BVar7 == 0 ||
      (BVar7 = IsValidLocale((p_Var4->_setloc_data)._cachecp,1), BVar7 == 0)))) {
    return 0;
  }
  if (_LpCodePage != (UINT *)0x0) {
    *(short *)_LpCodePage = (short)(p_Var4->_setloc_data)._cachecp;
    *(wchar_t *)((int)_LpCodePage + 2) = (p_Var4->_setloc_data)._cachein[0];
    *(short *)(_LpCodePage + 1) = (short)_Value;
  }
  if (_LpOutStr != (LPLC_STRINGS)0x0) {
    if ((short)*_LpCodePage == 0x814) {
      eVar8 = _strcpy_s((char *)_LpOutStr,0x40,"Norwegian-Nynorsk");
      if (eVar8 != 0) {
                    /* WARNING: Subroutine does not return */
        __invoke_watson((wchar_t *)0x0,(wchar_t *)0x0,(wchar_t *)0x0,0,0);
      }
    }
    else {
      iVar9 = GetLocaleInfoA((p_Var4->_setloc_data)._cachecp,0x1001,(LPSTR)_LpOutStr,0x40);
      if (iVar9 == 0) {
        return 0;
      }
    }
    iVar9 = GetLocaleInfoA(*(LCID *)(p_Var4->_setloc_data)._cachein,0x1002,
                           (LPSTR)(_LpOutStr->szLanguage + 0x20),0x40);
    if (iVar9 == 0) {
      return 0;
    }
    __itoa_s(_Value,(char *)_LpOutStr->szCountry,0x10,10);
  }
  return 1;
}



============================================================
DISASSEMBLY
============================================================
00655976 : MOV EDI,EDI
00655978 : PUSH EBP
00655979 : MOV EBP,ESP
0065597b : PUSH EBX
0065597c : PUSH ESI
0065597d : PUSH EDI
0065597e : CALL 0x006458f6
00655983 : MOV EBX,dword ptr [EBP + 0x8]
00655986 : MOV ESI,EAX
00655988 : ADD ESI,0x9c
0065598e : TEST EBX,EBX
00655990 : JNZ 0x0065599e
00655992 : OR dword ptr [ESI + 0x8],0x104
00655999 : JMP 0x00655a5b
0065599e : LEA EAX,[EBX + 0x40]
006559a1 : LEA EDI,[ESI + 0x4]
006559a4 : MOV dword ptr [ESI],EBX
006559a6 : MOV dword ptr [EDI],EAX
006559a8 : TEST EAX,EAX
006559aa : JZ 0x006559c1
006559ac : CMP byte ptr [EAX],0x0
006559af : JZ 0x006559c1
006559b1 : PUSH EDI
006559b2 : PUSH 0x16
006559b4 : PUSH 0xb9c958
006559b9 : CALL 0x006553bb
006559be : ADD ESP,0xc
006559c1 : MOV EAX,dword ptr [ESI]
006559c3 : AND dword ptr [ESI + 0x8],0x0
006559c7 : TEST EAX,EAX
006559c9 : JZ 0x00655a1e
006559cb : CMP byte ptr [EAX],0x0
006559ce : JZ 0x00655a1e
006559d0 : MOV EAX,dword ptr [EDI]
006559d2 : TEST EAX,EAX
006559d4 : JZ 0x006559e2
006559d6 : CMP byte ptr [EAX],0x0
006559d9 : JZ 0x006559e2
006559db : CALL 0x006558d3
006559e0 : JMP 0x006559e7
006559e2 : CALL 0x0065593a
006559e7 : CMP dword ptr [ESI + 0x8],0x0
006559eb : JNZ 0x00655a71
006559f1 : PUSH ESI
006559f2 : PUSH 0x40
006559f4 : PUSH 0xb9c750
006559f9 : CALL 0x006553bb
006559fe : ADD ESP,0xc
00655a01 : TEST EAX,EAX
00655a03 : JZ 0x00655a67
00655a05 : MOV EDI,dword ptr [EDI]
00655a07 : TEST EDI,EDI
00655a09 : JZ 0x00655a17
00655a0b : CMP byte ptr [EDI],0x0
00655a0e : JZ 0x00655a17
00655a10 : CALL 0x006558d3
00655a15 : JMP 0x00655a67
00655a17 : CALL 0x0065593a
00655a1c : JMP 0x00655a67
00655a1e : MOV EDI,dword ptr [EDI]
00655a20 : TEST EDI,EDI
00655a22 : JZ 0x00655a54
00655a24 : CMP byte ptr [EDI],0x0
00655a27 : JZ 0x00655a54
00655a29 : PUSH EDI
00655a2a : CALL 0x00640960
00655a2f : SUB EAX,0x3
00655a32 : NEG EAX
00655a34 : POP ECX
00655a35 : SBB EAX,EAX
00655a37 : PUSH 0x1
00655a39 : INC EAX
00655a3a : PUSH 0x655534
00655a3f : MOV dword ptr [ESI + 0x14],EAX
00655a42 : CALL dword ptr [0x00b85390]
00655a48 : TEST byte ptr [ESI + 0x8],0x4
00655a4c : JNZ 0x00655a67
00655a4e : AND dword ptr [ESI + 0x8],0x0
00655a52 : JMP 0x00655a67
00655a54 : MOV dword ptr [ESI + 0x8],0x104
00655a5b : CALL dword ptr [0x00b85370]
00655a61 : MOV dword ptr [ESI + 0x18],EAX
00655a64 : MOV dword ptr [ESI + 0x1c],EAX
00655a67 : CMP dword ptr [ESI + 0x8],0x0
00655a6b : JZ 0x00655b60
00655a71 : MOV ECX,EBX
00655a73 : SUB EBX,-0x80
00655a76 : NEG ECX
00655a78 : SBB ECX,ECX
00655a7a : AND ECX,EBX
00655a7c : MOV EDI,ESI
00655a7e : CALL 0x0065541d
00655a83 : MOV EDI,EAX
00655a85 : MOV dword ptr [EBP + 0x8],EDI
00655a88 : TEST EDI,EDI
00655a8a : JZ 0x00655b60
00655a90 : CMP EDI,0xfde8
00655a96 : JZ 0x00655b60
00655a9c : CMP EDI,0xfde9
00655aa2 : JZ 0x00655b60
00655aa8 : MOVZX EAX,DI
00655aab : PUSH EAX
00655aac : CALL dword ptr [0x00b85358]
00655ab2 : TEST EAX,EAX
00655ab4 : JZ 0x00655b60
00655aba : PUSH 0x1
00655abc : PUSH dword ptr [ESI + 0x18]
00655abf : CALL dword ptr [0x00b853b0]
00655ac5 : TEST EAX,EAX
00655ac7 : JZ 0x00655b60
00655acd : MOV EAX,dword ptr [EBP + 0xc]
00655ad0 : TEST EAX,EAX
00655ad2 : JZ 0x00655ae7
00655ad4 : MOV CX,word ptr [ESI + 0x18]
00655ad8 : MOV word ptr [EAX],CX
00655adb : MOV CX,word ptr [ESI + 0x1c]
00655adf : MOV word ptr [EAX + 0x2],CX
00655ae3 : MOV word ptr [EAX + 0x4],DI
00655ae7 : MOV EBX,dword ptr [EBP + 0x10]
00655aea : TEST EBX,EBX
00655aec : JZ 0x00655b5b
00655aee : MOV EDI,dword ptr [0x00b852d4]
00655af4 : MOV ECX,0x814
00655af9 : CMP word ptr [EAX],CX
00655afc : JNZ 0x00655b23
00655afe : PUSH 0xb9ca2c
00655b03 : PUSH 0x40
00655b05 : PUSH EBX
00655b06 : CALL 0x00638300
00655b0b : ADD ESP,0xc
00655b0e : TEST EAX,EAX
00655b10 : JZ 0x00655b34
00655b12 : XOR EAX,EAX
00655b14 : PUSH EAX
00655b15 : PUSH EAX
00655b16 : PUSH EAX
00655b17 : PUSH EAX
00655b18 : PUSH EAX
00655b19 : CALL 0x00637169
00655b23 : PUSH 0x40
00655b25 : PUSH EBX
00655b26 : PUSH 0x1001
00655b2b : PUSH dword ptr [ESI + 0x18]
00655b2e : CALL EDI
00655b30 : TEST EAX,EAX
00655b32 : JZ 0x00655b60
00655b34 : PUSH 0x40
00655b36 : LEA EAX,[EBX + 0x40]
00655b39 : PUSH EAX
00655b3a : PUSH 0x1002
00655b3f : PUSH dword ptr [ESI + 0x1c]
00655b42 : CALL EDI
00655b44 : TEST EAX,EAX
00655b46 : JZ 0x00655b60
00655b48 : PUSH 0xa
00655b4a : PUSH 0x10
00655b4c : SUB EBX,-0x80
00655b4f : PUSH EBX
00655b50 : PUSH dword ptr [EBP + 0x8]
00655b53 : CALL 0x00644cc6
00655b58 : ADD ESP,0x10
00655b5b : XOR EAX,EAX
00655b5d : INC EAX
00655b5e : JMP 0x00655b62
00655b60 : XOR EAX,EAX
00655b62 : POP EDI
00655b63 : POP ESI
00655b64 : POP EBX
00655b65 : POP EBP
00655b66 : RET
