PROGRAM  : Maestia.exe
FUNCTION : FUN_005ebf90
ENTRY    : 005ebf90
BODY     : [[005ebf90, 005ec2df]]

============================================================
DECOMPILED C CODE
============================================================

void FUN_005ebf90(int param_1)

{
  char cVar1;
  GRefCountImpl *this;
  HKL pHVar2;
  int iVar3;
  undefined4 uVar4;
  uint uVar5;
  int in_ECX;
  GRefCountNTSImpl *this_00;
  GRefCountNTSImpl *pGVar6;
  GRefCountNTSImpl *local_40;
  GRefCountNTSImpl *local_3c;
  undefined2 uStack_38;
  undefined2 uStack_36;
  GRefCountNTSImpl *local_34;
  undefined4 local_30;
  undefined2 auStack_2c [20];
  uint local_4;
  
  local_4 = DAT_00d66fa0 ^ (uint)&local_40;
  if (*(int *)(in_ECX + 0xb24) == 0) {
    iVar3 = *(int *)(in_ECX + 0xb28);
    if (iVar3 != 0) {
      this = (GRefCountImpl *)(**(code **)(*(int *)(in_ECX + 8) + 0xc))(4);
      if (this != (GRefCountImpl *)0x0) {
        GRefCountImpl::Release(this);
        FUN_00500460(this + 0xc,"Error: IMM32.DLL is not available, error code = 0x%X\n",iVar3);
      }
      *(undefined4 *)(in_ECX + 0xb28) = 0;
    }
    __security_check_cookie(local_4 ^ (uint)&local_40);
    return;
  }
  if (*(int *)(param_1 + 8) == 1) {
LAB_005ec2c9:
    __security_check_cookie(local_4 ^ (uint)&local_40);
    return;
  }
  uVar4 = *(undefined4 *)(param_1 + 0x18);
  local_30 = uVar4;
  pHVar2 = GetKeyboardLayout(0);
  if (((uint)pHVar2 & 0xffff) != 0x412) goto LAB_005ec2c9;
  uVar5 = *(uint *)(param_1 + 0xc);
  if (0x10f < uVar5) {
    if (uVar5 != 0x286) goto LAB_005ec2c9;
    goto LAB_005ec2a8;
  }
  if (uVar5 == 0x10f) {
    FUN_00597b80(&local_40);
    pGVar6 = local_40;
    if (local_40 == (GRefCountNTSImpl *)0x0) goto LAB_005ec2a8;
    iVar3 = (**(code **)(*(int *)local_40 + 0x9c))();
    this_00 = local_40;
    if (iVar3 != 4) goto LAB_005ec2a1;
    *(int *)(pGVar6 + 4) = *(int *)(pGVar6 + 4) + 1;
    cVar1 = (**(code **)(*(int *)local_40 + 0x170))();
    if (cVar1 == '\0') goto LAB_005ec29a;
    local_3c = *(GRefCountNTSImpl **)(param_1 + 0x10);
    local_40 = *(GRefCountNTSImpl **)(param_1 + 0x14);
    if (((uint)local_40 & 0x800) != 0) {
      if (*(code **)(in_ECX + 0xb08) == (code *)0x0) {
        uVar4 = 0;
      }
      else {
        uVar4 = (**(code **)(in_ECX + 0xb08))(uVar4);
      }
      if (*(code **)(in_ECX + 0xb14) == (code *)0x0) {
        uVar5 = 0;
      }
      else {
        uVar5 = (**(code **)(in_ECX + 0xb14))(uVar4,0x800,0,0);
      }
      if (*(code **)(in_ECX + 0xb14) == (code *)0x0) {
LAB_005ec1f2:
        iVar3 = *(int *)this_00;
        *(undefined2 *)((int)auStack_2c + (uVar5 & 0xfffffffe)) = 0;
        (**(code **)(iVar3 + 0x168))(0);
      }
      else {
        iVar3 = (**(code **)(in_ECX + 0xb14))(uVar4,0x800,auStack_2c,uVar5);
        if ((iVar3 != -1) && (iVar3 != -2)) goto LAB_005ec1f2;
      }
      if (*(code **)(in_ECX + 0xb0c) != (code *)0x0) {
        (**(code **)(in_ECX + 0xb0c))(local_30,uVar4);
      }
      (**(code **)(*(int *)this_00 + 0x180))(auStack_2c,0xffffffff);
    }
    if ((((uint)local_40 & 0x2000) != 0) && (((uint)local_40 & 0x4000) != 0)) {
      uStack_38 = local_3c._0_2_;
      uStack_36 = 0;
      (**(code **)(*(int *)this_00 + 0x168))(1);
      uVar4 = (**(code **)(*(int *)this_00 + 0x158))();
      (**(code **)(*(int *)this_00 + 0x188))(uVar4);
      (**(code **)(*(int *)this_00 + 0x184))(&local_40,1);
      (**(code **)(*(int *)this_00 + 0x194))(0);
    }
LAB_005ec29a:
    GRefCountNTSImpl::Release(this_00);
    pGVar6 = this_00;
  }
  else {
    if (uVar5 == 0x10d) {
      FUN_00597b80(&local_3c);
      pGVar6 = local_3c;
      if (local_3c == (GRefCountNTSImpl *)0x0) goto LAB_005ec2a8;
      iVar3 = (**(code **)(*(int *)local_3c + 0x9c))();
      this_00 = local_3c;
      if (iVar3 != 4) goto LAB_005ec2a1;
      *(int *)(pGVar6 + 4) = *(int *)(pGVar6 + 4) + 1;
      cVar1 = (**(code **)(*(int *)local_3c + 0x170))();
      if (cVar1 != '\0') {
        iVar3 = *(int *)this_00;
        uVar4 = (**(code **)(iVar3 + 0x160))(0xffffffff);
        uVar4 = (**(code **)(*(int *)this_00 + 0x15c))(uVar4);
        (**(code **)(iVar3 + 0x16c))(&DAT_00cca49c,uVar4);
        (**(code **)(*(int *)this_00 + 0x174))();
      }
      goto LAB_005ec29a;
    }
    if (uVar5 != 0x10e) goto LAB_005ec2c9;
    FUN_00597b80(&local_34);
    pGVar6 = local_34;
    if (local_34 == (GRefCountNTSImpl *)0x0) goto LAB_005ec2a8;
    iVar3 = (**(code **)(*(int *)local_34 + 0x9c))();
    if (iVar3 == 4) {
      pGVar6 = pGVar6 + 4;
      *(int *)pGVar6 = *(int *)pGVar6 + 1;
      cVar1 = (**(code **)(*(int *)local_34 + 0x170))();
      this_00 = local_34;
      if (cVar1 != '\0') {
        (**(code **)(*(int *)local_34 + 0x168))(0);
        (**(code **)(*(int *)local_34 + 0x178))();
      }
      goto LAB_005ec29a;
    }
  }
LAB_005ec2a1:
  GRefCountNTSImpl::Release(pGVar6);
LAB_005ec2a8:
  __security_check_cookie(local_4 ^ (uint)&local_40);
  return;
}



============================================================
DISASSEMBLY
============================================================
005ebf90 : SUB ESP,0x40
005ebf93 : MOV EAX,[0x00d66fa0]
005ebf98 : XOR EAX,ESP
005ebf9a : MOV dword ptr [ESP + 0x3c],EAX
005ebf9e : PUSH EBX
005ebf9f : PUSH ESI
005ebfa0 : MOV EBX,ECX
005ebfa2 : CMP dword ptr [EBX + 0xb24],0x0
005ebfa9 : PUSH EDI
005ebfaa : MOV EDI,dword ptr [ESP + 0x50]
005ebfae : JNZ 0x005ec006
005ebfb0 : MOV EDI,dword ptr [EBX + 0xb28]
005ebfb6 : TEST EDI,EDI
005ebfb8 : JZ 0x005ebff0
005ebfba : MOV EAX,dword ptr [EBX + 0x8]
005ebfbd : MOV EDX,dword ptr [EAX + 0xc]
005ebfc0 : LEA ECX,[EBX + 0x8]
005ebfc3 : PUSH 0x4
005ebfc5 : CALL EDX
005ebfc7 : MOV ESI,EAX
005ebfc9 : TEST ESI,ESI
005ebfcb : JZ 0x005ebfe6
005ebfcd : MOV ECX,ESI
005ebfcf : CALL 0x004ff7e0
005ebfd4 : PUSH EDI
005ebfd5 : PUSH 0xb9485c
005ebfda : ADD ESI,0xc
005ebfdd : PUSH ESI
005ebfde : CALL 0x00500460
005ebfe3 : ADD ESP,0xc
005ebfe6 : MOV dword ptr [EBX + 0xb28],0x0
005ebff0 : POP EDI
005ebff1 : POP ESI
005ebff2 : XOR EAX,EAX
005ebff4 : POP EBX
005ebff5 : MOV ECX,dword ptr [ESP + 0x3c]
005ebff9 : XOR ECX,ESP
005ebffb : CALL 0x00633e6b
005ec000 : ADD ESP,0x40
005ec003 : RET 0x4
005ec006 : CMP dword ptr [EDI + 0x8],0x1
005ec00a : PUSH EBP
005ec00b : JZ 0x005ec2c9
005ec011 : MOV EBP,dword ptr [EDI + 0x18]
005ec014 : PUSH 0x0
005ec016 : MOV dword ptr [ESP + 0x24],EBP
005ec01a : CALL dword ptr [0x00b8551c]
005ec020 : AND EAX,0xffff
005ec025 : CMP EAX,0x412
005ec02a : JNZ 0x005ec2c9
005ec030 : MOV EAX,dword ptr [EDI + 0xc]
005ec033 : CMP EAX,0x10f
005ec038 : JA 0x005ec2c2
005ec03e : JZ 0x005ec13f
005ec044 : SUB EAX,0x10d
005ec049 : JZ 0x005ec0bb
005ec04b : SUB EAX,0x1
005ec04e : JNZ 0x005ec2c9
005ec054 : LEA EAX,[ESP + 0x1c]
005ec058 : PUSH EAX
005ec059 : MOV ECX,EBX
005ec05b : CALL 0x00597b80
005ec060 : MOV ESI,dword ptr [ESP + 0x1c]
005ec064 : TEST ESI,ESI
005ec066 : JZ 0x005ec2a8
005ec06c : MOV EDX,dword ptr [ESI]
005ec06e : MOV EAX,dword ptr [EDX + 0x9c]
005ec074 : MOV ECX,ESI
005ec076 : CALL EAX
005ec078 : CMP EAX,0x4
005ec07b : JNZ 0x005ec2a1
005ec081 : INC dword ptr [ESI + 0x4]
005ec084 : MOV ESI,dword ptr [ESP + 0x1c]
005ec088 : MOV EDX,dword ptr [ESI]
005ec08a : MOV EAX,dword ptr [EDX + 0x170]
005ec090 : MOV ECX,ESI
005ec092 : CALL EAX
005ec094 : TEST AL,AL
005ec096 : JZ 0x005ec29a
005ec09c : MOV EDX,dword ptr [ESI]
005ec09e : MOV EAX,dword ptr [EDX + 0x168]
005ec0a4 : PUSH 0x0
005ec0a6 : MOV ECX,ESI
005ec0a8 : CALL EAX
005ec0aa : MOV EDX,dword ptr [ESI]
005ec0ac : MOV EAX,dword ptr [EDX + 0x178]
005ec0b2 : MOV ECX,ESI
005ec0b4 : CALL EAX
005ec0b6 : JMP 0x005ec29a
005ec0bb : LEA ECX,[ESP + 0x14]
005ec0bf : PUSH ECX
005ec0c0 : MOV ECX,EBX
005ec0c2 : CALL 0x00597b80
005ec0c7 : MOV ESI,dword ptr [ESP + 0x14]
005ec0cb : TEST ESI,ESI
005ec0cd : JZ 0x005ec2a8
005ec0d3 : MOV EDX,dword ptr [ESI]
005ec0d5 : MOV EAX,dword ptr [EDX + 0x9c]
005ec0db : MOV ECX,ESI
005ec0dd : CALL EAX
005ec0df : CMP EAX,0x4
005ec0e2 : JNZ 0x005ec2a1
005ec0e8 : INC dword ptr [ESI + 0x4]
005ec0eb : MOV ESI,dword ptr [ESP + 0x14]
005ec0ef : MOV EDX,dword ptr [ESI]
005ec0f1 : MOV EAX,dword ptr [EDX + 0x170]
005ec0f7 : MOV ECX,ESI
005ec0f9 : CALL EAX
005ec0fb : TEST AL,AL
005ec0fd : JZ 0x005ec29a
005ec103 : MOV EDI,dword ptr [ESI]
005ec105 : MOV EDX,dword ptr [EDI + 0x160]
005ec10b : PUSH -0x1
005ec10d : MOV ECX,ESI
005ec10f : CALL EDX
005ec111 : PUSH EAX
005ec112 : MOV EAX,dword ptr [ESI]
005ec114 : MOV EDX,dword ptr [EAX + 0x15c]
005ec11a : MOV ECX,ESI
005ec11c : CALL EDX
005ec11e : PUSH EAX
005ec11f : MOV EAX,dword ptr [EDI + 0x16c]
005ec125 : PUSH 0xcca49c
005ec12a : MOV ECX,ESI
005ec12c : CALL EAX
005ec12e : MOV EDX,dword ptr [ESI]
005ec130 : MOV EAX,dword ptr [EDX + 0x174]
005ec136 : MOV ECX,ESI
005ec138 : CALL EAX
005ec13a : JMP 0x005ec29a
005ec13f : LEA ECX,[ESP + 0x10]
005ec143 : PUSH ECX
005ec144 : MOV ECX,EBX
005ec146 : CALL 0x00597b80
005ec14b : MOV ESI,dword ptr [ESP + 0x10]
005ec14f : TEST ESI,ESI
005ec151 : JZ 0x005ec2a8
005ec157 : MOV EDX,dword ptr [ESI]
005ec159 : MOV EAX,dword ptr [EDX + 0x9c]
005ec15f : MOV ECX,ESI
005ec161 : CALL EAX
005ec163 : CMP EAX,0x4
005ec166 : JNZ 0x005ec2a1
005ec16c : INC dword ptr [ESI + 0x4]
005ec16f : MOV ESI,dword ptr [ESP + 0x10]
005ec173 : MOV EDX,dword ptr [ESI]
005ec175 : MOV EAX,dword ptr [EDX + 0x170]
005ec17b : MOV ECX,ESI
005ec17d : CALL EAX
005ec17f : TEST AL,AL
005ec181 : JZ 0x005ec29a
005ec187 : MOV ECX,dword ptr [EDI + 0x10]
005ec18a : MOV EDI,dword ptr [EDI + 0x14]
005ec18d : MOV dword ptr [ESP + 0x14],ECX
005ec191 : MOV dword ptr [ESP + 0x10],EDI
005ec195 : TEST EDI,0x800
005ec19b : JZ 0x005ec231
005ec1a1 : MOV EAX,dword ptr [EBX + 0xb08]
005ec1a7 : TEST EAX,EAX
005ec1a9 : JZ 0x005ec1b2
005ec1ab : PUSH EBP
005ec1ac : CALL EAX
005ec1ae : MOV EBP,EAX
005ec1b0 : JMP 0x005ec1b4
005ec1b2 : XOR EBP,EBP
005ec1b4 : MOV EAX,dword ptr [EBX + 0xb14]
005ec1ba : TEST EAX,EAX
005ec1bc : JZ 0x005ec1ce
005ec1be : PUSH 0x0
005ec1c0 : PUSH 0x0
005ec1c2 : PUSH 0x800
005ec1c7 : PUSH EBP
005ec1c8 : CALL EAX
005ec1ca : MOV EDI,EAX
005ec1cc : JMP 0x005ec1d0
005ec1ce : XOR EDI,EDI
005ec1d0 : MOV EAX,dword ptr [EBX + 0xb14]
005ec1d6 : TEST EAX,EAX
005ec1d8 : JZ 0x005ec1f2
005ec1da : PUSH EDI
005ec1db : LEA EDX,[ESP + 0x28]
005ec1df : PUSH EDX
005ec1e0 : PUSH 0x800
005ec1e5 : PUSH EBP
005ec1e6 : CALL EAX
005ec1e8 : CMP EAX,-0x1
005ec1eb : JZ 0x005ec208
005ec1ed : CMP EAX,-0x2
005ec1f0 : JZ 0x005ec208
005ec1f2 : MOV EDX,dword ptr [ESI]
005ec1f4 : XOR EAX,EAX
005ec1f6 : SHR EDI,0x1
005ec1f8 : MOV word ptr [ESP + EDI*0x2 + 0x24],AX
005ec1fd : PUSH EAX
005ec1fe : MOV EAX,dword ptr [EDX + 0x168]
005ec204 : MOV ECX,ESI
005ec206 : CALL EAX
005ec208 : MOV EBX,dword ptr [EBX + 0xb0c]
005ec20e : TEST EBX,EBX
005ec210 : JZ 0x005ec21a
005ec212 : MOV ECX,dword ptr [ESP + 0x20]
005ec216 : PUSH EBP
005ec217 : PUSH ECX
005ec218 : CALL EBX
005ec21a : MOV EDX,dword ptr [ESI]
005ec21c : MOV EDX,dword ptr [EDX + 0x180]
005ec222 : PUSH -0x1
005ec224 : LEA EAX,[ESP + 0x28]
005ec228 : PUSH EAX
005ec229 : MOV ECX,ESI
005ec22b : CALL EDX
005ec22d : MOV EDI,dword ptr [ESP + 0x10]
005ec231 : TEST EDI,0x2000
005ec237 : JZ 0x005ec29a
005ec239 : TEST EDI,0x4000
005ec23f : JZ 0x005ec29a
005ec241 : MOV AX,word ptr [ESP + 0x14]
005ec246 : MOV EDX,dword ptr [ESI]
005ec248 : XOR ECX,ECX
005ec24a : MOV word ptr [ESP + 0x18],AX
005ec24f : MOV EAX,dword ptr [EDX + 0x168]
005ec255 : MOV word ptr [ESP + 0x1a],CX
005ec25a : PUSH 0x1
005ec25c : MOV ECX,ESI
005ec25e : CALL EAX
005ec260 : MOV EDX,dword ptr [ESI]
005ec262 : MOV EAX,dword ptr [EDX + 0x158]
005ec268 : MOV ECX,ESI
005ec26a : CALL EAX
005ec26c : MOV EDX,dword ptr [ESI]
005ec26e : PUSH EAX
005ec26f : MOV EAX,dword ptr [EDX + 0x188]
005ec275 : MOV ECX,ESI
005ec277 : CALL EAX
005ec279 : MOV EDX,dword ptr [ESI]
005ec27b : MOV EDX,dword ptr [EDX + 0x184]
005ec281 : PUSH 0x1
005ec283 : LEA EAX,[ESP + 0x1c]
005ec287 : PUSH EAX
005ec288 : MOV ECX,ESI
005ec28a : CALL EDX
005ec28c : MOV EAX,dword ptr [ESI]
005ec28e : MOV EDX,dword ptr [EAX + 0x194]
005ec294 : PUSH 0x0
005ec296 : MOV ECX,ESI
005ec298 : CALL EDX
005ec29a : MOV ECX,ESI
005ec29c : CALL 0x004ff7c0
005ec2a1 : MOV ECX,ESI
005ec2a3 : CALL 0x004ff7c0
005ec2a8 : POP EBP
005ec2a9 : POP EDI
005ec2aa : POP ESI
005ec2ab : MOV EAX,0x2
005ec2b0 : POP EBX
005ec2b1 : MOV ECX,dword ptr [ESP + 0x3c]
005ec2b5 : XOR ECX,ESP
005ec2b7 : CALL 0x00633e6b
005ec2bc : ADD ESP,0x40
005ec2bf : RET 0x4
005ec2c2 : CMP EAX,0x286
005ec2c7 : JZ 0x005ec2a8
005ec2c9 : MOV ECX,dword ptr [ESP + 0x4c]
005ec2cd : POP EBP
005ec2ce : POP EDI
005ec2cf : POP ESI
005ec2d0 : POP EBX
005ec2d1 : XOR ECX,ESP
005ec2d3 : XOR EAX,EAX
005ec2d5 : CALL 0x00633e6b
005ec2da : ADD ESP,0x40
005ec2dd : RET 0x4
