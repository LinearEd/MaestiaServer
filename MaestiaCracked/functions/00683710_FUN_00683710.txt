PROGRAM  : Maestia.exe
FUNCTION : FUN_00683710
ENTRY    : 00683710
BODY     : [[00683710, 00683956]]

============================================================
DECOMPILED C CODE
============================================================

void FUN_00683710(void)

{
  GRefCountImpl *this;
  HIMC pHVar1;
  DWORD dwBufLen;
  short *lpBuf;
  LONG LVar2;
  int iVar3;
  uint *puVar4;
  undefined4 uVar5;
  int in_ECX;
  int *unaff_retaddr;
  undefined1 auStack_34 [4];
  uint local_30;
  undefined4 local_2c;
  undefined4 uStack_24;
  undefined4 uStack_20;
  undefined4 uStack_1c;
  undefined4 uStack_18;
  undefined4 uStack_14;
  undefined4 uStack_10;
  undefined4 uStack_c;
  undefined4 uStack_8;
  
  local_30 = 0;
  local_2c = 0;
  this = (GRefCountImpl *)(**(code **)(*(int *)(*(int *)(in_ECX + 4) + 8) + 0xc))(0x1b);
  pHVar1 = ImmGetContext(*(HWND *)(in_ECX + 0x14));
  dwBufLen = ImmGetCompositionStringW(pHVar1,8,(LPVOID)0x0,0);
  lpBuf = (short *)FUN_00515840(dwBufLen * 2 + 2,0);
  ImmGetCompositionStringW(pHVar1,8,lpBuf,dwBufLen);
  lpBuf[(int)dwBufLen / 2] = 0;
  if ((*lpBuf == 0x20) || (*lpBuf == 0x3000)) {
    *lpBuf = 0xa0;
  }
  if (*(int *)(in_ECX + 0x5c) == 0x60000) {
    FUN_0051bb60(lpBuf);
    FUN_00515cf0(lpBuf);
    if (this != (GRefCountImpl *)0x0) {
      GRefCountImpl::Release(this);
    }
    if ((local_30 >> 6 & 1) != 0) {
      FUN_00588b40(auStack_34,local_2c);
      return;
    }
  }
  else {
    FUN_005973b0(lpBuf,0xffffffff);
    *unaff_retaddr = (int)dwBufLen / 2;
    if ((*(int *)(in_ECX + 0x5c) == 0x210000) || (*(int *)(in_ECX + 0x5c) == 0x110000)) {
      LVar2 = ImmGetCompositionStringW(pHVar1,0x80,(LPVOID)0x0,0);
      FUN_00597400(LVar2);
      *(int *)(in_ECX + 0x34) = *unaff_retaddr - LVar2;
      FUN_00597440(0,*unaff_retaddr,0,0);
    }
    if (dwBufLen != 0) {
      LVar2 = ImmGetCompositionStringW(pHVar1,0x80,(LPVOID)0x0,0);
      FUN_00597400(LVar2);
    }
    uStack_14 = 0;
    uStack_10 = 0;
    uStack_c = 0;
    uStack_8 = 0;
    uStack_24 = 0;
    uStack_20 = 0;
    uStack_1c = 0;
    uStack_18 = 0;
    FUN_00597610(&uStack_14,&uStack_24,0);
    iVar3 = FUN_0051b1a0();
    if ((iVar3 != 0) && ((*(byte *)(in_ECX + 0x5c) & 0xf) == 0)) {
      puVar4 = (uint *)FUN_0051c6e0(&stack0x00000000,".RepositionInputWindow");
      uVar5 = FUN_0063b380();
      uVar5 = FUN_0063b380(uVar5);
      FUN_00678eb0(*(undefined4 *)(in_ECX + 4),(*puVar4 & 0xfffffffc) + 8,"%d %d",uVar5);
      LVar2 = InterlockedExchangeAdd((LONG *)(((uint)unaff_retaddr & 0xfffffffc) + 4),-1);
      if (LVar2 == 1) {
        FUN_00515cf0((uint)unaff_retaddr & 0xfffffffc);
      }
    }
    ImmReleaseContext(*(HWND *)(in_ECX + 0x14),pHVar1);
    FUN_00515cf0(lpBuf);
    if (this != (GRefCountImpl *)0x0) {
      GRefCountImpl::Release(this);
    }
    if ((local_30 >> 6 & 1) != 0) {
      FUN_00588b40(auStack_34,local_2c);
    }
  }
  return;
}



============================================================
DISASSEMBLY
============================================================
00683710 : SUB ESP,0x38
00683713 : PUSH EBX
00683714 : PUSH EBP
00683715 : PUSH ESI
00683716 : MOV ESI,ECX
00683718 : MOV ECX,dword ptr [ESI + 0x4]
0068371b : PUSH EDI
0068371c : XOR EDI,EDI
0068371e : ADD ECX,0x8
00683721 : MOV dword ptr [ESP + 0x18],EDI
00683725 : MOV dword ptr [ESP + 0x1c],EDI
00683729 : MOV EAX,dword ptr [ECX]
0068372b : MOV EDX,dword ptr [EAX + 0xc]
0068372e : PUSH 0x1b
00683730 : CALL EDX
00683732 : MOV EBX,EAX
00683734 : MOV EAX,dword ptr [ESI + 0x14]
00683737 : PUSH EAX
00683738 : CALL 0x00611450
0068373d : PUSH EDI
0068373e : PUSH EDI
0068373f : PUSH 0x8
00683741 : PUSH EAX
00683742 : MOV dword ptr [ESP + 0x20],EAX
00683746 : CALL 0x00685b84
0068374b : MOV EBP,EAX
0068374d : PUSH EDI
0068374e : LEA ECX,[EBP + EBP*0x1 + 0x2]
00683752 : PUSH ECX
00683753 : MOV ECX,dword ptr [0x00d73250]
00683759 : MOV dword ptr [ESP + 0x1c],EBP
0068375d : CALL 0x00515840
00683762 : MOV EDX,dword ptr [ESP + 0x10]
00683766 : PUSH EBP
00683767 : MOV EDI,EAX
00683769 : PUSH EDI
0068376a : PUSH 0x8
0068376c : PUSH EDX
0068376d : CALL 0x00685b84
00683772 : MOV EAX,EBP
00683774 : CDQ
00683775 : SUB EAX,EDX
00683777 : MOV EBP,EAX
00683779 : XOR EAX,EAX
0068377b : SAR EBP,0x1
0068377d : MOV word ptr [EDI + EBP*0x2],AX
00683781 : MOVZX EAX,word ptr [EDI]
00683784 : CMP AX,0x20
00683788 : JZ 0x00683794
0068378a : MOV ECX,0x3000
0068378f : CMP AX,CX
00683792 : JNZ 0x0068379c
00683794 : MOV EDX,0xa0
00683799 : MOV word ptr [EDI],DX
0068379c : CMP dword ptr [ESI + 0x5c],0x60000
006837a3 : JNZ 0x006837eb
006837a5 : PUSH EDI
006837a6 : LEA ECX,[ESI + 0x68]
006837a9 : CALL 0x0051bb60
006837ae : PUSH EDI
006837af : CALL 0x00515cf0
006837b4 : TEST EBX,EBX
006837b6 : JZ 0x006837bf
006837b8 : MOV ECX,EBX
006837ba : CALL 0x004ff7e0
006837bf : MOV EAX,dword ptr [ESP + 0x1c]
006837c3 : SHR EAX,0x6
006837c6 : TEST AL,0x1
006837c8 : JZ 0x0068394d
006837ce : MOV ECX,dword ptr [ESP + 0x20]
006837d2 : PUSH ECX
006837d3 : MOV ECX,dword ptr [ESP + 0x1c]
006837d7 : LEA EDX,[ESP + 0x1c]
006837db : PUSH EDX
006837dc : CALL 0x00588b40
006837e1 : POP EDI
006837e2 : POP ESI
006837e3 : POP EBP
006837e4 : POP EBX
006837e5 : ADD ESP,0x38
006837e8 : RET 0x4
006837eb : PUSH -0x1
006837ed : PUSH EDI
006837ee : MOV ECX,EBX
006837f0 : CALL 0x005973b0
006837f5 : MOV EAX,dword ptr [ESP + 0x4c]
006837f9 : MOV dword ptr [EAX],EBP
006837fb : MOV EAX,dword ptr [ESI + 0x5c]
006837fe : CMP EAX,0x210000
00683803 : JZ 0x0068380c
00683805 : CMP EAX,0x110000
0068380a : JNZ 0x00683844
0068380c : MOV ECX,dword ptr [ESP + 0x10]
00683810 : PUSH 0x0
00683812 : PUSH 0x0
00683814 : PUSH 0x80
00683819 : PUSH ECX
0068381a : CALL 0x00685b84
0068381f : MOV EBP,EAX
00683821 : PUSH EBP
00683822 : MOV ECX,EBX
00683824 : CALL 0x00597400
00683829 : MOV EAX,dword ptr [ESP + 0x4c]
0068382d : MOV EDX,dword ptr [EAX]
0068382f : PUSH 0x0
00683831 : SUB EDX,EBP
00683833 : MOV dword ptr [ESI + 0x34],EDX
00683836 : MOV EAX,dword ptr [EAX]
00683838 : PUSH 0x0
0068383a : PUSH EAX
0068383b : PUSH 0x0
0068383d : MOV ECX,EBX
0068383f : CALL 0x00597440
00683844 : CMP dword ptr [ESP + 0x14],0x0
00683849 : JZ 0x00683866
0068384b : MOV ECX,dword ptr [ESP + 0x10]
0068384f : PUSH 0x0
00683851 : PUSH 0x0
00683853 : PUSH 0x80
00683858 : PUSH ECX
00683859 : CALL 0x00685b84
0068385e : PUSH EAX
0068385f : MOV ECX,EBX
00683861 : CALL 0x00597400
00683866 : FLDZ
00683868 : PUSH 0x0
0068386a : FST float ptr [ESP + 0x3c]
0068386e : LEA EDX,[ESP + 0x2c]
00683872 : FST float ptr [ESP + 0x40]
00683876 : PUSH EDX
00683877 : FST float ptr [ESP + 0x48]
0068387b : LEA EAX,[ESP + 0x40]
0068387f : FST float ptr [ESP + 0x4c]
00683883 : PUSH EAX
00683884 : FST float ptr [ESP + 0x34]
00683888 : MOV ECX,EBX
0068388a : FST float ptr [ESP + 0x38]
0068388e : FST float ptr [ESP + 0x3c]
00683892 : FSTP float ptr [ESP + 0x40]
00683896 : CALL 0x00597610
0068389b : LEA EBP,[ESI + 0x8]
0068389e : MOV ECX,EBP
006838a0 : CALL 0x0051b1a0
006838a5 : TEST EAX,EAX
006838a7 : JBE 0x0068390f
006838a9 : TEST byte ptr [ESI + 0x5c],0xf
006838ad : JNZ 0x0068390f
006838af : PUSH 0xbd8208
006838b4 : LEA ECX,[ESP + 0x50]
006838b8 : PUSH ECX
006838b9 : MOV ECX,EBP
006838bb : CALL 0x0051c6e0
006838c0 : FLD float ptr [ESP + 0x34]
006838c4 : MOV EBP,EAX
006838c6 : CALL 0x0063b380
006838cb : FLD float ptr [ESP + 0x28]
006838cf : PUSH EAX
006838d0 : CALL 0x0063b380
006838d5 : MOV EDX,dword ptr [EBP]
006838d8 : PUSH EAX
006838d9 : MOV EAX,dword ptr [ESI + 0x4]
006838dc : AND EDX,0xfffffffc
006838df : PUSH 0xbd6554
006838e4 : ADD EDX,0x8
006838e7 : PUSH EDX
006838e8 : PUSH EAX
006838e9 : CALL 0x00678eb0
006838ee : MOV EBP,dword ptr [ESP + 0x60]
006838f2 : ADD ESP,0x14
006838f5 : AND EBP,0xfffffffc
006838f8 : PUSH -0x1
006838fa : LEA ECX,[EBP + 0x4]
006838fd : PUSH ECX
006838fe : CALL dword ptr [0x00b851cc]
00683904 : SUB EAX,0x1
00683907 : JNZ 0x0068390f
00683909 : PUSH EBP
0068390a : CALL 0x00515cf0
0068390f : MOV EDX,dword ptr [ESP + 0x10]
00683913 : MOV EAX,dword ptr [ESI + 0x14]
00683916 : PUSH EDX
00683917 : PUSH EAX
00683918 : CALL 0x00611462
0068391d : PUSH EDI
0068391e : CALL 0x00515cf0
00683923 : TEST EBX,EBX
00683925 : JZ 0x0068392e
00683927 : MOV ECX,EBX
00683929 : CALL 0x004ff7e0
0068392e : MOV ECX,dword ptr [ESP + 0x1c]
00683932 : SHR ECX,0x6
00683935 : TEST CL,0x1
00683938 : JZ 0x0068394d
0068393a : MOV EDX,dword ptr [ESP + 0x20]
0068393e : MOV ECX,dword ptr [ESP + 0x18]
00683942 : PUSH EDX
00683943 : LEA EAX,[ESP + 0x1c]
00683947 : PUSH EAX
00683948 : CALL 0x00588b40
0068394d : POP EDI
0068394e : POP ESI
0068394f : POP EBP
00683950 : POP EBX
00683951 : ADD ESP,0x38
00683954 : RET 0x4
