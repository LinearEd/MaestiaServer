PROGRAM  : Maestia.exe
FUNCTION : FUN_00473630
ENTRY    : 00473630
BODY     : [[00473630, 00473a59]]

============================================================
DECOMPILED C CODE
============================================================

void FUN_00473630(int param_1,int param_2)

{
  float fVar1;
  byte bVar2;
  int iVar3;
  int iVar4;
  int *piVar5;
  float *pfVar6;
  float *pfVar7;
  int iVar8;
  float *pfVar9;
  float *pfVar10;
  float10 fVar11;
  float fVar12;
  float fVar13;
  float fVar14;
  float fVar15;
  float fVar16;
  undefined4 uStack_64;
  int local_60;
  int local_4c;
  int local_48;
  undefined1 local_34 [4];
  float *local_30;
  void *local_14;
  undefined1 *puStack_10;
  undefined4 local_c;
  
  local_c = 0xffffffff;
  puStack_10 = &LAB_00b82aca;
  local_14 = ExceptionList;
  ExceptionList = &local_14;
  FUN_00473080(DAT_00d66fa0 ^ (uint)&stack0xffffff90);
  if (local_4c != 0) {
    if (local_48 == 0) {
      piVar5 = (int *)0x0;
    }
    else {
      piVar5 = (int *)(*(int *)(local_48 + 4) + local_4c);
    }
    iVar3 = *piVar5;
    while (iVar3 != 0) {
      bVar2 = *(byte *)(iVar3 + 0x1f8);
      uStack_64 = (float)((uint)bVar2 << 0x18);
      if ((*(char *)(iVar3 + 0x1f9) == '\0') ||
         (uStack_64 = (float)CONCAT13(bVar2,0x10000), *(char *)(param_1 + 0xd14) == '\0')) {
        uStack_64 = (float)((uint)uStack_64 & 0xff000000);
      }
      iVar8 = (uint)(uStack_64._2_1_ != '\0') + (uint)(bVar2 != 0);
      if (iVar8 != 0) {
        local_60 = 0;
        pfVar6 = (float *)FUN_00474740(param_2 + 0x38);
        iVar4 = *(int *)(iVar3 + 0x10e4);
        if (iVar4 < 0) {
          FUN_00807d70("CForestRI::UpdateBillboardVbos, instance count, %d, for base tree [%s] in cell [%d, %d] exceeded limit of [%d]"
                       ,0,iVar3 + 0xc,*(undefined4 *)(param_2 + 4),*(undefined4 *)(param_2 + 8),
                       iVar4);
          local_60 = iVar4;
        }
        if (0 < local_60) {
          FUN_00473220(local_34,local_60 * iVar8 * 4,"UpdateBillboardVbos");
          local_c = 0;
          pfVar9 = local_30;
          pfVar10 = pfVar6;
          if (0 < local_60) {
            do {
              fVar1 = pfVar10[3];
              fVar12 = (float)*(byte *)((int)pfVar10 + 0x22) * 0.003921569 * 6.2831855;
              if (uStack_64._3_1_ != '\0') {
                *(undefined8 *)pfVar9 = *(undefined8 *)pfVar10;
                pfVar9[2] = pfVar10[2];
                pfVar9[4] = fVar1;
                fVar13 = fVar12 * 0.1511972;
                pfVar9[3] = fVar13;
                *(undefined8 *)(pfVar9 + 5) = *(undefined8 *)pfVar10;
                pfVar9[7] = pfVar10[2];
                pfVar9[9] = fVar1;
                pfVar9[8] = fVar13 + 1.0;
                *(undefined8 *)(pfVar9 + 10) = *(undefined8 *)pfVar10;
                pfVar9[0xc] = pfVar10[2];
                pfVar9[0xe] = fVar1;
                pfVar9[0xd] = fVar13 + 2.0;
                fVar15 = pfVar10[1];
                pfVar9[0xf] = *pfVar10;
                pfVar9[0x10] = fVar15;
                pfVar9[0x11] = pfVar10[2];
                pfVar9[0x12] = fVar13 + 3.0;
                pfVar9[0x13] = fVar1;
                pfVar9 = pfVar9 + 0x14;
              }
              if (uStack_64._2_1_ != '\0') {
                fVar11 = (float10)(**(code **)(*(int *)PTR_DAT_00d6df20 + 0x28))
                                            (*(undefined4 *)(iVar3 + 0x158),
                                             *(undefined4 *)(iVar3 + 0x15c),
                                             *(undefined4 *)(iVar3 + 0x160));
                uStack_64 = (float)fVar11;
                pfVar7 = (float *)(**(code **)(*(int *)PTR_DAT_00d6df20 + 0x1c))();
                fVar15 = pfVar7[2];
                fVar16 = *pfVar10 + *pfVar7 * (float)pfVar6 * fVar1;
                fVar14 = pfVar10[1] + pfVar7[1] * (float)pfVar6 * fVar1;
                fVar13 = pfVar10[2];
                pfVar9[4] = fVar1;
                fVar13 = fVar13 + fVar15 * (float)pfVar6 * fVar1;
                fVar12 = fVar12 * 0.1511972;
                *pfVar9 = fVar16;
                pfVar9[1] = fVar14;
                pfVar9[2] = fVar13;
                pfVar9[3] = fVar12 + 4.0;
                pfVar9[5] = fVar16;
                pfVar9[6] = fVar14;
                pfVar9[7] = fVar13;
                pfVar9[9] = fVar1;
                pfVar9[8] = fVar12 + DAT_00d72c20;
                pfVar9[10] = fVar16;
                pfVar9[0xb] = fVar14;
                pfVar9[0xc] = fVar13;
                pfVar9[0xe] = fVar1;
                fVar15 = fVar12 + DAT_00d72a88;
                pfVar9[0xd] = fVar12 + 6.0;
                pfVar9[0xf] = fVar16;
                pfVar9[0x10] = fVar14;
                pfVar9[0x11] = fVar13;
                pfVar9[0x12] = fVar15;
                pfVar9[0x13] = fVar1;
                pfVar9 = pfVar9 + 0x14;
              }
              local_60 = local_60 + -1;
              pfVar10 = pfVar10 + 0x50;
            } while (local_60 != 0);
          }
          if ((*(char *)(iVar3 + 0x1f9) == '\0') || (*(char *)(iVar3 + 0x10ec) == '\0')) {
            iVar8 = 0;
          }
          else {
            iVar8 = 1;
          }
          if (*(int *)(iVar3 + 0x1088) == 0) {
            FUN_00807d70(
                        "CGeometryBufferRI::OverwriteVertices, cannot be called until a VB is established with AppendVertices() + EndVertices()"
                        );
          }
          else {
            FUN_00473540(local_30,*(int *)(iVar3 + 0x10e4) *
                                  ((uint)(*(char *)(iVar3 + 0x1f8) != '\0') + iVar8) *
                                  *(int *)(param_2 + 0x84) * 4);
          }
          local_c = 0xffffffff;
          FUN_00473480(local_34);
        }
      }
      FUN_004735a0();
      if (local_4c == 0) {
        ExceptionList = local_14;
        return;
      }
      if (local_48 == 0) {
        piVar5 = (int *)0x0;
      }
      else {
        piVar5 = (int *)(*(int *)(local_48 + 4) + local_4c);
      }
      iVar3 = *piVar5;
    }
  }
  ExceptionList = local_14;
  return;
}



============================================================
DISASSEMBLY
============================================================
00473630 : PUSH EBP
00473631 : MOV EBP,ESP
00473633 : AND ESP,0xfffffff8
00473636 : PUSH -0x1
00473638 : PUSH 0xb82aca
0047363d : MOV EAX,FS:[0x0]
00473643 : PUSH EAX
00473644 : SUB ESP,0x50
00473647 : PUSH EBX
00473648 : PUSH ESI
00473649 : PUSH EDI
0047364a : MOV EAX,[0x00d66fa0]
0047364f : XOR EAX,ESP
00473651 : PUSH EAX
00473652 : LEA EAX,[ESP + 0x60]
00473656 : MOV FS:[0x0],EAX
0047365c : MOV EDI,dword ptr [EBP + 0xc]
0047365f : ADD EDI,0x38
00473662 : LEA ESI,[ESP + 0x28]
00473666 : CALL 0x00473080
0047366b : MOV ECX,dword ptr [ESP + 0x28]
0047366f : TEST ECX,ECX
00473671 : JZ 0x00473a45
00473677 : MOV EAX,dword ptr [ESP + 0x2c]
0047367b : TEST EAX,EAX
0047367d : JZ 0x00473686
0047367f : MOV EAX,dword ptr [EAX + 0x4]
00473682 : ADD EAX,ECX
00473684 : JMP 0x00473688
00473686 : XOR EAX,EAX
00473688 : MOV EBX,dword ptr [EAX]
0047368a : TEST EBX,EBX
0047368c : JZ 0x00473a45
00473692 : CMP byte ptr [EBX + 0x1f9],0x0
00473699 : MOV AL,byte ptr [EBX + 0x1f8]
0047369f : MOV byte ptr [ESP + 0x13],AL
004736a3 : JZ 0x004736b6
004736a5 : MOV ECX,dword ptr [EBP + 0x8]
004736a8 : CMP byte ptr [ECX + 0xd14],0x0
004736af : MOV byte ptr [ESP + 0x12],0x1
004736b4 : JNZ 0x004736bb
004736b6 : MOV byte ptr [ESP + 0x12],0x0
004736bb : XOR EDX,EDX
004736bd : CMP byte ptr [ESP + 0x12],DL
004736c1 : SETNZ DL
004736c4 : XOR ECX,ECX
004736c6 : TEST AL,AL
004736c8 : SETNZ CL
004736cb : ADD EDX,ECX
004736cd : MOV EAX,EDX
004736cf : MOV dword ptr [ESP + 0x18],EAX
004736d3 : TEST EAX,EAX
004736d5 : JLE 0x00473a19
004736db : MOV EAX,dword ptr [EBP + 0xc]
004736de : ADD EAX,0x38
004736e1 : PUSH EAX
004736e2 : LEA EDI,[ESP + 0x18]
004736e6 : LEA EAX,[ESP + 0x2c]
004736ea : MOV dword ptr [ESP + 0x18],0x0
004736f2 : CALL 0x00474740
004736f7 : MOV ESI,dword ptr [EBX + 0x10e4]
004736fd : MOV EDI,dword ptr [ESP + 0x14]
00473701 : CMP EDI,ESI
00473703 : MOV dword ptr [ESP + 0x1c],EAX
00473707 : JLE 0x0047372d
00473709 : MOV ECX,dword ptr [EBP + 0xc]
0047370c : MOV EAX,dword ptr [ECX + 0x8]
0047370f : MOV ECX,dword ptr [ECX + 0x4]
00473712 : PUSH ESI
00473713 : PUSH EAX
00473714 : PUSH ECX
00473715 : LEA EDX,[EBX + 0xc]
00473718 : PUSH EDX
00473719 : PUSH EDI
0047371a : PUSH 0xcd60d8
0047371f : CALL 0x00807d70
00473724 : ADD ESP,0x18
00473727 : MOV dword ptr [ESP + 0x14],ESI
0047372b : MOV EDI,ESI
0047372d : TEST EDI,EDI
0047372f : JLE 0x00473a19
00473735 : MOV EAX,EDI
00473737 : IMUL EAX,dword ptr [ESP + 0x18]
0047373c : ADD EAX,EAX
0047373e : ADD EAX,EAX
00473740 : PUSH 0xcd6148
00473745 : PUSH EAX
00473746 : MOV dword ptr [ESP + 0x20],EAX
0047374a : LEA EAX,[ESP + 0x48]
0047374e : PUSH EAX
0047374f : CALL 0x00473220
00473754 : MOV dword ptr [ESP + 0x68],0x0
0047375c : MOV ESI,dword ptr [ESP + 0x44]
00473760 : TEST EDI,EDI
00473762 : JLE 0x00473991
00473768 : MOV ECX,dword ptr [ESP + 0x14]
0047376c : MOV EDI,dword ptr [ESP + 0x1c]
00473770 : MOVSS XMM3,dword ptr [0x00cdf194]
00473778 : MOV dword ptr [ESP + 0x14],ECX
0047377c : LEA ESP,[ESP]
00473780 : CMP byte ptr [ESP + 0x13],0x0
00473785 : MOVZX EDX,byte ptr [EDI + 0x22]
00473789 : MOVSS XMM1,dword ptr [EDI + 0xc]
0047378e : CVTSI2SS XMM0,EDX
00473792 : MULSS XMM0,dword ptr [0x00cdf178]
0047379a : MULSS XMM0,dword ptr [0x00c1884c]
004737a2 : MOVSS dword ptr [ESP + 0x20],XMM1
004737a8 : MOVSS dword ptr [ESP + 0x24],XMM0
004737ae : JZ 0x00473843
004737b4 : MOVQ XMM2,qword ptr [EDI]
004737b8 : MOVQ qword ptr [ESI],XMM2
004737bc : MOV EAX,dword ptr [EDI + 0x8]
004737bf : MOV dword ptr [ESI + 0x8],EAX
004737c2 : MOVSS dword ptr [ESI + 0x10],XMM1
004737c7 : ADD ESI,0x14
004737ca : MULSS XMM0,XMM3
004737ce : MOVSS dword ptr [ESI + -0x8],XMM0
004737d3 : MOVQ XMM2,qword ptr [EDI]
004737d7 : MOVQ qword ptr [ESI],XMM2
004737db : MOV ECX,dword ptr [EDI + 0x8]
004737de : MOV dword ptr [ESI + 0x8],ECX
004737e1 : MOVSS dword ptr [ESI + 0x10],XMM1
004737e6 : MOVAPS XMM2,XMM0
004737e9 : ADDSS XMM2,dword ptr [0x00c10fc4]
004737f1 : MOVSS dword ptr [ESI + 0xc],XMM2
004737f6 : MOVQ XMM2,qword ptr [EDI]
004737fa : MOVQ qword ptr [ESI + 0x14],XMM2
004737ff : MOV EDX,dword ptr [EDI + 0x8]
00473802 : ADD ESI,0x14
00473805 : MOV dword ptr [ESI + 0x8],EDX
00473808 : MOVSS dword ptr [ESI + 0x10],XMM1
0047380d : MOVAPS XMM2,XMM0
00473810 : ADDSS XMM2,dword ptr [0x00cdf144]
00473818 : ADDSS XMM0,dword ptr [0x00cdf19c]
00473820 : MOVSS dword ptr [ESI + 0xc],XMM2
00473825 : MOVQ XMM2,qword ptr [EDI]
00473829 : ADD ESI,0x14
0047382c : MOVQ qword ptr [ESI],XMM2
00473830 : MOV EAX,dword ptr [EDI + 0x8]
00473833 : MOV dword ptr [ESI + 0x8],EAX
00473836 : MOVSS dword ptr [ESI + 0xc],XMM0
0047383b : MOVSS dword ptr [ESI + 0x10],XMM1
00473840 : ADD ESI,0x14
00473843 : CMP byte ptr [ESP + 0x12],0x0
00473848 : JZ 0x00473980
0047384e : FLD float ptr [EBX + 0x160]
00473854 : MOV ECX,dword ptr [0x00d6df20]
0047385a : MOV EDX,dword ptr [ECX]
0047385c : MOV EAX,dword ptr [EDX + 0x28]
0047385f : SUB ESP,0xc
00473862 : FSTP float ptr [ESP + 0x8]
00473866 : FLD float ptr [EBX + 0x15c]
0047386c : FSTP float ptr [ESP + 0x4]
00473870 : FLD float ptr [EBX + 0x158]
00473876 : FSTP float ptr [ESP]
00473879 : CALL EAX
0047387b : MOV ECX,dword ptr [0x00d6df20]
00473881 : FSTP float ptr [ESP + 0x1c]
00473885 : MOV EDX,dword ptr [ECX]
00473887 : MOV EAX,dword ptr [EDX + 0x1c]
0047388a : CALL EAX
0047388c : MOVSS XMM2,dword ptr [EAX + 0x4]
00473891 : MOVSS XMM0,dword ptr [EAX]
00473895 : MOVSS XMM3,dword ptr [EAX + 0x8]
0047389a : MOVSS XMM4,dword ptr [EDI]
0047389e : MOVSS XMM1,dword ptr [ESP + 0x1c]
004738a4 : MULSS XMM0,XMM1
004738a8 : MULSS XMM2,XMM1
004738ac : MULSS XMM3,XMM1
004738b0 : MOVSS XMM1,dword ptr [ESP + 0x20]
004738b6 : MULSS XMM0,XMM1
004738ba : ADDSS XMM4,XMM0
004738be : MOVSS XMM0,dword ptr [EDI + 0x4]
004738c3 : MULSS XMM2,XMM1
004738c7 : ADDSS XMM0,XMM2
004738cb : MOVSS XMM2,dword ptr [EDI + 0x8]
004738d0 : MOVSS dword ptr [ESI + 0x10],XMM1
004738d5 : MOVSS dword ptr [ESP + 0x34],XMM4
004738db : MOVSS dword ptr [ESP + 0x38],XMM0
004738e1 : MOVSS XMM0,dword ptr [ESP + 0x24]
004738e7 : MULSS XMM3,XMM1
004738eb : ADDSS XMM2,XMM3
004738ef : MOVSS XMM3,dword ptr [0x00cdf194]
004738f7 : MULSS XMM0,XMM3
004738fb : ADD ESI,0x14
004738fe : MOVSS dword ptr [ESP + 0x3c],XMM2
00473904 : MOVQ XMM2,qword ptr [ESP + 0x34]
0047390a : MOV EAX,dword ptr [ESP + 0x3c]
0047390e : MOVQ qword ptr [ESI + -0x14],XMM2
00473913 : MOV dword ptr [ESI + -0xc],EAX
00473916 : MOVAPS XMM4,XMM0
00473919 : ADDSS XMM4,dword ptr [0x00cdf21c]
00473921 : MOVSS dword ptr [ESI + -0x8],XMM4
00473926 : MOVQ qword ptr [ESI],XMM2
0047392a : MOV dword ptr [ESI + 0x8],EAX
0047392d : MOVSS dword ptr [ESI + 0x10],XMM1
00473932 : ADD ESI,0x14
00473935 : MOVAPS XMM4,XMM0
00473938 : ADDSS XMM4,dword ptr [0x00d72c20]
00473940 : MOVSS dword ptr [ESI + -0x8],XMM4
00473945 : MOVQ qword ptr [ESI],XMM2
00473949 : MOV dword ptr [ESI + 0x8],EAX
0047394c : MOVSS dword ptr [ESI + 0x10],XMM1
00473951 : MOVAPS XMM4,XMM0
00473954 : ADDSS XMM4,dword ptr [0x00cdf148]
0047395c : ADDSS XMM0,dword ptr [0x00d72a88]
00473964 : MOVSS dword ptr [ESI + 0xc],XMM4
00473969 : ADD ESI,0x14
0047396c : MOVQ qword ptr [ESI],XMM2
00473970 : MOV dword ptr [ESI + 0x8],EAX
00473973 : MOVSS dword ptr [ESI + 0xc],XMM0
00473978 : MOVSS dword ptr [ESI + 0x10],XMM1
0047397d : ADD ESI,0x14
00473980 : ADD EDI,0x140
00473986 : SUB dword ptr [ESP + 0x14],0x1
0047398b : JNZ 0x00473780
00473991 : CMP byte ptr [EBX + 0x1f9],0x0
00473998 : JZ 0x004739aa
0047399a : CMP byte ptr [EBX + 0x10ec],0x0
004739a1 : JZ 0x004739aa
004739a3 : MOV ESI,0x1
004739a8 : JMP 0x004739ac
004739aa : XOR ESI,ESI
004739ac : MOV AL,byte ptr [EBX + 0x1f8]
004739b2 : MOV EDX,dword ptr [EBP + 0xc]
004739b5 : MOV EDX,dword ptr [EDX + 0x84]
004739bb : XOR ECX,ECX
004739bd : TEST AL,AL
004739bf : MOV EAX,dword ptr [EBX + 0x10e4]
004739c5 : SETNZ CL
004739c8 : ADD ECX,ESI
004739ca : IMUL EAX,ECX
004739cd : IMUL EAX,EDX
004739d0 : ADD EAX,EAX
004739d2 : ADD EAX,EAX
004739d4 : CMP dword ptr [EBX + 0x1088],0x0
004739db : JZ 0x004739fa
004739dd : MOV ECX,dword ptr [ESP + 0x18]
004739e1 : PUSH EAX
004739e2 : MOV EAX,dword ptr [ESP + 0x48]
004739e6 : PUSH EAX
004739e7 : MOV EAX,dword ptr [EBX + 0x10b4]
004739ed : LEA EDI,[EBX + 0x1080]
004739f3 : CALL 0x00473540
004739f8 : JMP 0x00473a07
004739fa : PUSH 0xcd6238
004739ff : CALL 0x00807d70
00473a04 : ADD ESP,0x4
00473a07 : MOV dword ptr [ESP + 0x68],0xffffffff
00473a0f : LEA ECX,[ESP + 0x40]
00473a13 : PUSH ECX
00473a14 : CALL 0x00473480
00473a19 : LEA ESI,[ESP + 0x28]
00473a1d : CALL 0x004735a0
00473a22 : MOV ECX,dword ptr [ESP + 0x28]
00473a26 : TEST ECX,ECX
00473a28 : JZ 0x00473a45
00473a2a : MOV EAX,dword ptr [ESP + 0x2c]
00473a2e : TEST EAX,EAX
00473a30 : JZ 0x00473a39
00473a32 : MOV EAX,dword ptr [EAX + 0x4]
00473a35 : ADD EAX,ECX
00473a37 : JMP 0x00473a3b
00473a39 : XOR EAX,EAX
00473a3b : MOV EBX,dword ptr [EAX]
00473a3d : TEST EBX,EBX
00473a3f : JNZ 0x00473692
00473a45 : MOV ECX,dword ptr [ESP + 0x60]
00473a49 : MOV dword ptr FS:[0x0],ECX
00473a50 : POP ECX
00473a51 : POP EDI
00473a52 : POP ESI
00473a53 : POP EBX
00473a54 : MOV ESP,EBP
00473a56 : POP EBP
00473a57 : RET 0x8
